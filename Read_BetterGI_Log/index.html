<!-- 
    é©ç”¨æ–¼BetterGI 0.48.0
    20250820æ–°å¢äº†çœ‹æ­»äº¡å‰æœ€è¿‘çš„XYè»¸ 
    20250821
        ä¿®æ­£ç•¶æœ‰å¡æ­»èˆ‡å¤æ´»åŒæ™‚å­˜åœ¨æ¬¡æ•¸æ™‚ï¼Œå¤æ´»é¡¯ç¤ºä¸å‡ºXYè»¸ 
        æ–°å¢
            æ–°å¢è¡Œé«˜äº®ã€é¼ æ¨™ç§»åˆ°è¡¨æ ¼è¡Œæ™‚é«˜äº®ã€æç¤ºç•¶å‰åœ¨çœ‹å“ªä¸€è¡Œ
            æŒ‰Téµéš±è—æˆ–é¡¯ç¤º å¼€å§‹æ—¶é—´&ç»“æŸæ—¶é—´
            æŒ‰Yéµéš±è—æˆ–é¡¯ç¤º å¤æ´»æ¬¡æ•°ã€é‡è¯•æ¬¡æ•°ã€ç–‘ä¼¼å¡æ­»æ¬¡æ•°ã€è¿‡è¿œè·³è¿‡ã€æˆ˜æ–—è¶…æ—¶ã€ä¼ é€å¤±è´¥
            æŒ‰Uéµåˆ‡æ›è¡¨æ ¼æ ¼å¼ï¼ˆæ—§ç‰ˆ/æ–°ç‰ˆï¼‰
            æŒ‰Iéµéš±è—æˆ–é¡¯ç¤º æ‹¾å–ç‰©åˆ—
            é›™æ“Šé¡¯ç¤ºæ•¸å­—çš„å¤æˆ˜æ–—è¶…æ—¶/ç–‘ä¼¼å¡æ­»æ¬¡æ•°/å¤æ´»æ¬¡æ•°æ ¼æ™‚ã€é‡ç½®è©²æ ¼ç”Ÿæˆçš„å°è¦–çª—ä½ç½®
            æŒ‰Pé€²å…¥å°å‡ºæ¨¡å¼ï¼Œé¡¯ç¤ºæˆ˜æ–—è¶…æ—¶/ç–‘ä¼¼å¡æ­»æ¬¡æ•°/å¤æ´»æ¬¡æ•°å°è¦–çª—è©³ç´°ã€æ–¹ä¾¿åˆ†äº«
                å°å‡ºæ¨¡å¼ä¸­å†æ¬¡æŒ‰Pé€€å‡ºå°å‡ºæ¨¡å¼
            æ‰‹æ©Ÿç‰ˆå¯é€‰æ‹©æ—¥å¿—æ–‡ä»¶ä¸Šå‚³
            å½“æŒ‰ä¸‹Jé”®æ—¶ï¼Œæ‰€æœ‰ç»Ÿè®¡åˆ—ï¼ˆå¤æ´»æ¬¡æ•°ã€é‡è¯•æ¬¡æ•°ã€ç–‘ä¼¼å¡æ­»ã€è¿‡è¿œè·³è¿‡ã€æˆ˜æ–—è¶…æ—¶ã€ä¼ é€å¤±è´¥ï¼‰éƒ½ä¸º0æˆ–ç©ºçš„ä»»åŠ¡è¡Œä¼šè¢«éšè—æˆ–æ˜¾ç¤ºï¼Œæ–¹ä¾¿ç”¨æˆ·ä¸“æ³¨äºæœ‰é—®é¢˜çš„ä»»åŠ¡ã€‚
    -->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>æ—¥å¿—åˆ†æå·¥å…·</title>
    <style>
        html,
        body {
            background: #f8f9fa;
            color: #333;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        #container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #dropZone {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px dashed #ccc;
            margin: 10px;
            transition: background-color 0.3s;
            overflow: auto;
        }

        #dropZone.dragover {
            background-color: #f0f0f0;
            border-color: #666;
        }

        #dropZone.empty {
            font-size: 24px;
            color: #666;
        }

        #dropZone.has-content {
            padding: 20px;
            align-items: flex-start;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #888;
            position: sticky;
            top: 0;
            /* å›ºå®šåœ¨é¡µé¢é¡¶éƒ¨ */
            z-index: 1;
            /* ç¡®ä¿è¡¨å¤´åœ¨å†…å®¹ä¸Šæ–¹ */
        }

        tr:nth-child(odd) {
            background-color: #eaeaea;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .red {
            color: red;
            font-weight: bold;
        }

        /* æ–°å¢æŠ˜å ç›¸å…³æ ·å¼ */
        .group-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin: 5px 0;
        }

        .group-header:hover {
            background-color: #e9ecef;
        }

        .arrow {
            display: inline-block;
            margin-right: 10px;
            transition: transform 0.2s;
        }

        .arrow.collapsed {
            transform: rotate(-90deg);
        }

        .group-container {
            margin-left: 20px;
            border-left: 2px solid #dee2e6;
            padding-left: 10px;
        }

        .collapsible {
            display: block;
        }

        .collapsible.collapsed {
            display: none;
        }

        /* æš—è‰²ä¸»é¢˜æ ·å¼ */
        body.dark-theme {
            background-color: #121212;
            color: #ffffff;
        }

        body.dark-theme #dropZone {
            border-color: #666;
            background-color: #1e1e1e;
        }

        body.dark-theme table {
            border-color: #444;
        }

        body.dark-theme th,
        body.dark-theme td {
            border-color: #444;
            color: #ffffff;
        }

        body.dark-theme th {
            background-color: #888;
        }

        body.dark-theme tr:nth-child(odd) {
            background-color: #2a2a2a;
        }

        body.dark-theme tr:nth-child(even) {
            background-color: #1e1e1e;
        }

        body.dark-theme .group-header {
            background-color: #333;
            color: #ffffff;
        }

        body.dark-theme .group-header:hover {
            background-color: #444;
        }

        body.dark-theme .red {
            color: #ff6666;
        }

        /* å¼¹çª—æ ·å¼ */
        .coord-popup {
            display: none;
            position: fixed;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            max-width: 250px;
            font-size: 14px;
            cursor: default;
            user-select: text;
        }

        .coord-popup.visible {
            display: block;
        }

        .coord-popup-header {
            background-color: #eee;
            padding: 8px 12px;
            border-bottom: 1px solid #ccc;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .coord-popup-title {
            font-weight: bold;
        }

        .coord-popup .close-btn {
            cursor: pointer;
            font-size: 18px;
            color: #999;
            padding: 0 5px;
        }

        .coord-popup .close-btn:hover {
            color: #000;
        }

        .coord-popup-content {
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .coord-popup .coord-item {
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px dashed #ddd;
            cursor: text;
        }

        .coord-popup .coord-item:last-child {
            border-bottom: none;
        }

        /* æš—è‰²ä¸»é¢˜ä¸‹çš„å¼¹çª—æ ·å¼ */
        body.dark-theme .coord-popup {
            background-color: #333;
            border: 1px solid #666;
            color: #fff;
        }

        body.dark-theme .coord-popup-header {
            background-color: #444;
            border-bottom: 1px solid #555;
        }

        body.dark-theme .coord-popup .close-btn {
            color: #ccc;
        }

        body.dark-theme .coord-popup .close-btn:hover {
            color: #fff;
        }

        body.dark-theme .coord-popup .coord-item {
            border-bottom: 1px dashed #555;
        }

        /* å•å…ƒæ ¼å›ºå®šçŠ¶æ€æŒ‡ç¤ºå™¨ */
        .coords-cell.pinned::after {
            content: "ğŸ“Œ";
            margin-left: 5px;
            font-size: 12px;
        }

        /* ä¿®æ”¹å•å…ƒæ ¼å…‰æ ‡æ ·å¼ */
        .coords-cell {
            position: relative;
            /* é»˜è®¤ä½¿ç”¨ç®­å¤´å…‰æ ‡ */
            cursor: default;
        }

        /* å½“å•å…ƒæ ¼æœ‰æ•°å­—æ—¶ä½¿ç”¨æ‰‹æŒ‡å…‰æ ‡ */
        .coords-cell.has-coords {
            cursor: pointer;
        }

        /* æ–°å¢æç¤ºæ–‡æœ¬æ ·å¼ */
        .dispatch-alert {
            color: orange;
            font-weight: bold;
        }

        .pause-alert {
            color: rgb(255, 0, 255);
            font-weight: bold;
        }

        /* æ›´äº®çš„é»„è‰² */
        .abnormal-alert {
            color: red;
            font-weight: bold;
        }

        /* æ–°å¢çº¢è‰²ä»»åŠ¡åç§°æ ·å¼ */
        .task-name-red {
            color: red;
            font-weight: bold;
        }

        .duration-red {
            color: red;
            font-weight: bold;
        }

        /* æ–°å¢å¼¹çª—æ ·å¼ */
        .battle-popup {
            display: none;
            position: fixed;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            max-width: 250px;
            max-height: 400px;
            font-size: 14px;
            cursor: default;
            user-select: text;
            overflow: auto;
        }

        .battle-popup.visible {
            display: block;
        }

        .battle-popup-header {
            background-color: #eee;
            padding: 8px 12px;
            border-bottom: 1px solid #ccc;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
        }

        .battle-popup-title {
            font-weight: bold;
        }

        .battle-popup .close-btn {
            cursor: pointer;
            font-size: 18px;
            color: #999;
            padding: 0 5px;
        }

        .battle-popup .close-btn:hover {
            color: #000;
        }

        .battle-popup-content {
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .battle-popup .battle-item {
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px dashed #ddd;
            font-family: monospace;
        }

        .battle-popup .battle-item:last-child {
            border-bottom: none;
        }

        /* æš—è‰²ä¸»é¢˜ä¸‹çš„å¼¹çª—æ ·å¼ */
        body.dark-theme .battle-popup {
            background-color: #333;
            border: 1px solid #666;
            color: #fff;
        }

        body.dark-theme .battle-popup-header {
            background-color: #444;
            border-bottom: 1px solid #555;
        }

        body.dark-theme .battle-popup .close-btn {
            color: #ccc;
        }

        body.dark-theme .battle-popup .close-btn:hover {
            color: #fff;
        }

        body.dark-theme .battle-popup .battle-item {
            border-bottom: 1px dashed #555;
        }

        /* å•å…ƒæ ¼æ ·å¼ */
        .has-battle-events {
            cursor: pointer;
            position: relative;
        }

        .has-battle-events.pinned::after {
            content: "ğŸ“Œ";
            margin-left: 5px;
            font-size: 12px;
        }

        /* æ— äº‹ä»¶æ—¶ä¸å¯ç‚¹å‡» */
        .no-events {
            cursor: default !important;
        }

        /* æ–°å¢ï¼šæ—¶é—´åˆ—éšè—çŠ¶æ€æ ·å¼ */
        .time-columns-hidden .column-start-time,
        .time-columns-hidden .column-end-time {
            display: none;
        }

        /* æ–°å¢ï¼šæ—¶é—´åˆ—æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨ */
        .time-toggle-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .time-toggle-indicator.visible {
            opacity: 1;
        }

        /* æ–°å¢ï¼šç»Ÿè®¡åˆ—éšè—çŠ¶æ€æ ·å¼ */
        .stats-columns-hidden .column-revive,
        .stats-columns-hidden .column-retry,
        .stats-columns-hidden .column-retry-detail,
        .stats-columns-hidden .column-too-far-skip,
        .stats-columns-hidden .column-timeout,
        .stats-columns-hidden .column-teleport {
            display: none;
        }

        /* æ–°å¢ï¼šç»Ÿè®¡åˆ—æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨ */
        .stats-toggle-indicator {
            position: fixed;
            bottom: 60px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .legacy-format .group-header {
            /* ç§»é™¤stickyå®šä½ */
            position: static;
            background-color: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
        }

        body.dark-theme .legacy-format .group-header {
            background-color: #333;
        }

        /* ç¡®ä¿è¡¨æ ¼è¡¨å¤´ä¿æŒå›ºå®š */
        .legacy-format .sticky-header {
            position: sticky;
            top: 0;
            background-color: #888;
            z-index: 2;
        }

        .legacy-format .main-row-name {
            /* ç§»é™¤ç²—ä½“ */
            font-weight: normal;
            background-color: #f0f0f0;
        }

        .legacy-format .sub-row {
            background-color: #f9f9f9;
        }

        .legacy-format .ignore-sort {
            background-color: #e0e0e0;
        }

        .ignore-sort {
            font-weight: normal;
        }

        /* æš—è‰²ä¸»é¢˜ä¸‹çš„æ–°ç‰ˆè¡¨æ ¼æ ·å¼ */
        body.dark-theme .legacy-format .main-row-name {
            background-color: #2a2a2a;
        }

        body.dark-theme .legacy-format .sub-row {
            background-color: #1e1e1e;
        }

        body.dark-theme .legacy-format .ignore-sort {
            background-color: #333;
        }

        /* æ ‡é¢˜è·Ÿéšé¡µé¢åŠŸèƒ½ */
        .sticky-title {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 100;
            padding: 10px;
            margin: -10px -10px 10px -10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        body.dark-theme .sticky-title {
            background-color: #1e1e1e;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* æ‹¾å–ç‰©ç²—ä½“æ ·å¼ */
        .picks-bold {
            font-weight: bold;
        }

        /* è¡Œé«˜äº®æ ·å¼ */
        tr.highlighted {
            background-color: #e6f7ff !important;
            /* ç™½è‰²æ¨¡å¼ä¸‹çš„æ·¡è“è‰² */
        }

        body.dark-theme tr.highlighted {
            background-color: #3a3a3a !important;
            /* é»‘è‰²æ¨¡å¼ä¸‹çš„ä¸­ç°è‰² */
        }

        /* æ–°å¢ï¼šå¸®åŠ©æç¤ºæ ·å¼ */
        .help-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .help-indicator.visible {
            opacity: 1;
        }

        /* é»˜è®¤äº®è‰²ä¸»é¢˜ä¸‹çš„å¸®åŠ©æç¤ºæ ·å¼ */
        .help-indicator {
            background-color: #000;
            color: #fff;
        }

        /* æš—è‰²ä¸»é¢˜ä¸‹çš„å¸®åŠ©æç¤ºæ ·å¼ */
        body.dark-theme .help-indicator {
            background-color: #fff;
            color: #000;
        }

        /* æ–°å¢ï¼šæ‹¾å–ç‰©åˆ—éšè—çŠ¶æ€æ ·å¼ */
        .picks-columns-hidden .column-picks {
            display: none;
        }

        /* è°ƒæ•´æŒ‡ç¤ºå™¨ä½ç½® */
        .stats-toggle-indicator#picksToggleIndicator {
            bottom: 60px;
        }

        /* æ–°å¢å¯¼å‡ºç›¸å…³æ ·å¼ */
        .mode-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 10000;
            display: none;
        }

        .static-mode .mode-indicator {
            display: block;
            background-color: rgba(76, 175, 80, 0.8);
        }

        /* é™æ€æ¨¡å¼ä¸‹å¼¹çª—çš„æ ·å¼ */
        .static-mode .coord-popup,
        .static-mode .battle-popup {
            display: block !important;
            position: static !important;
            margin: 10px 0;
            box-shadow: none;
            max-width: 100%;
            max-height: none;
        }

        .static-mode .coord-popup-header,
        .static-mode .battle-popup-header {
            cursor: default;
            background-color: #e0e0e0;
            /* color: #333; */
        }

        .static-mode .close-btn {
            display: none;
        }

        .static-mode .coords-cell,
        .static-mode .has-battle-events {
            cursor: default;
        }

        .static-mode .coords-cell.pinned::after,
        .static-mode .has-battle-events.pinned::after {
            content: "";
        }

        /* æç¤ºæ¡†æ ·å¼ */
        .custom-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            min-width: 300px;
            text-align: center;
            display: none;
        }

        .custom-alert h3 {
            margin-top: 0;
            color: #333;
        }

        .custom-alert-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .custom-alert-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .custom-alert-confirm {
            background-color: #4CAF50;
            color: white;
        }

        .custom-alert-cancel {
            background-color: #f44336;
            color: white;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
        }

        body.dark-theme .custom-alert {
            background-color: #333;
            color: #fff;
        }

        body.dark-theme .custom-alert h3 {
            color: #fff;
        }

        /* æ–°å¢ç§»åŠ¨è®¾å¤‡ä¸Šä¼ æŒ‰é’®æ ·å¼ */
        #fileUploadContainer {
            display: none;
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }

        #fileUploadBtn {
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        #fileUploadBtn:hover {
            background-color: #45a049;
        }

        #fileInput {
            display: none;
        }

        /* æš—è‰²ä¸»é¢˜é€‚é… */
        body.dark-theme #fileUploadContainer {
            background-color: #2a2a2a;
            border-color: #555;
        }

        /* æ–°å¢ç§»åŠ¨è®¾å¤‡æ ·å¼ */
        @media (max-width: 768px),
        (pointer: coarse) {
            body {
                text-size-adjust: none;
                -webkit-text-size-adjust: none;
            }

            .task-name-red,
            .main-row-name,
            .group-header h2 {
                font-size: 16px;
                line-height: 1.4;
                text-size-adjust: none;
                -webkit-text-size-adjust: none;
            }

            table {
                font-size: 14px;
            }

            th,
            td {
                padding: 6px 4px;
            }

            /* ç§»åŠ¨è®¾å¤‡ä¸Šä¼ æŒ‰é’®æ ·å¼ */
            #fileUploadContainer {
                display: block;
                text-align: center;
                margin: 15px;
                padding: 15px;
                border: 2px dashed #ccc;
                border-radius: 8px;
                background-color: #f9f9f9;
            }

            #fileUploadBtn {
                padding: 12px 24px;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                transition: background-color 0.3s;
            }

            #fileUploadBtn:hover {
                background-color: #45a049;
            }

            #fileInput {
                display: none;
            }
        }

        /* éç§»åŠ¨è®¾å¤‡é»˜è®¤éšè—ä¸Šä¼ åŒºåŸŸ */
        #fileUploadContainer {
            display: none;
        }

        /* æ·»åŠ é›¶ç»Ÿè®¡ä»»åŠ¡æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ */
        .stats-toggle-indicator#zeroStatsToggleIndicator {
            bottom: 160px;
        }
    </style>
</head>

<body>
    <div class="mode-indicator">é™æ€æ¨¡å¼ - è¯·ä½¿ç”¨æµè§ˆå™¨"å¦å­˜æ–°æ¡£"åŠŸèƒ½ä¿å­˜é¡µé¢</div>

    <div id="container">
        <div id="dropZone" class="empty">å°†æ—¥å¿—æ–‡ä»¶æ‹–æ”¾åˆ°æ­¤å¤„</div>
        <!-- æ–°å¢ç§»åŠ¨è®¾å¤‡ä¸Šä¼ åŒºåŸŸ -->
        <div id="fileUploadContainer">
            <input type="file" id="fileInput" accept=".log,.txt" multiple>
            <button id="fileUploadBtn">é€‰æ‹©æ—¥å¿—æ–‡ä»¶</button>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰æç¤ºæ¡† -->
    <div class="overlay" id="alertOverlay"></div>
    <div class="custom-alert" id="customAlert">
        <h3 id="alertTitle">ç¡®è®¤æ“ä½œ</h3>
        <p id="alertMessage">æ‚¨ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
        <div class="custom-alert-buttons">
            <button class="custom-alert-btn custom-alert-confirm" id="alertConfirm">ç¡®å®š</button>
            <button class="custom-alert-btn custom-alert-cancel" id="alertCancel">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- æ–°å¢ï¼šæ—¶é—´åˆ—æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="time-toggle-indicator" id="timeToggleIndicator"></div>
    <!-- æ–°å¢ï¼šç»Ÿè®¡åˆ—æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="stats-toggle-indicator" id="statsToggleIndicator"></div>
    <!-- æ–°å¢ï¼šè¡¨æ ¼æ ¼å¼æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="stats-toggle-indicator" id="formatToggleIndicator" style="bottom: 110px;"></div>
    <!-- åœ¨HTMLä¸­æ·»åŠ æ‹¾å–ç‰©åˆ—æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="stats-toggle-indicator" id="picksToggleIndicator" style="bottom: 60px;"></div>
    <!-- åœ¨HTMLä¸­æ·»åŠ é›¶ç»Ÿè®¡ä»»åŠ¡æ˜¾ç¤ºçŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div class="stats-toggle-indicator" id="zeroStatsToggleIndicator" style="bottom: 160px;"></div>
    <!-- æ–°å¢ï¼šå¸®åŠ©æç¤ºæŒ‡ç¤ºå™¨ -->
    <div class="help-indicator" id="helpIndicator">æŒ‰ 0 é”®æŸ¥çœ‹è¯´æ˜</div>

    <script>
        // å…¨å±€å˜é‡
        let lastValidTime = null;
        let timeColumnsVisible = true; // è·Ÿè¸ªæ—¶é—´åˆ—çš„æ˜¾ç¤ºçŠ¶æ€
        let statsColumnsVisible = true; // è·Ÿè¸ªç»Ÿè®¡åˆ—çš„æ˜¾ç¤ºçŠ¶æ€
        let useLegacyFormat = false; // è·Ÿè¸ªè¡¨æ ¼æ ¼å¼çŠ¶æ€
        let picksColumnsVisible = true; // è·Ÿè¸ªæ‹¾å–ç‰©åˆ—çš„æ˜¾ç¤ºçŠ¶æ€
        let hasLogData = false; // è·Ÿè¸ªæ˜¯å¦æœ‰æ—¥å¿—æ•°æ®
        let hideZeroStatsTasks = false; // è·Ÿè¸ªæ˜¯å¦éšè—æ‰€æœ‰ç»Ÿè®¡ä¸º0çš„ä»»åŠ¡
        let isStaticMode = false;

        // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        function showCustomConfirm(title, message) {
            return new Promise((resolve) => {
                const alert = document.getElementById('customAlert');
                const overlay = document.getElementById('alertOverlay');
                const titleEl = document.getElementById('alertTitle');
                const messageEl = document.getElementById('alertMessage');
                const confirmBtn = document.getElementById('alertConfirm');
                const cancelBtn = document.getElementById('alertCancel');

                // è®¾ç½®æ ‡é¢˜å’Œæ¶ˆæ¯
                titleEl.textContent = title;
                messageEl.textContent = message;

                // æ˜¾ç¤ºå¯¹è¯æ¡†
                alert.style.display = 'block';
                overlay.style.display = 'block';

                // å¤„ç†ç¡®è®¤æŒ‰é’®ç‚¹å‡»
                const onConfirm = () => {
                    cleanup();
                    resolve(true);
                };

                // å¤„ç†å–æ¶ˆæŒ‰é’®ç‚¹å‡»
                const onCancel = () => {
                    cleanup();
                    resolve(false);
                };

                // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
                const cleanup = () => {
                    confirmBtn.removeEventListener('click', onConfirm);
                    cancelBtn.removeEventListener('click', onCancel);
                    overlay.removeEventListener('click', onCancel);
                    alert.style.display = 'none';
                    overlay.style.display = 'none';
                };

                // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                confirmBtn.addEventListener('click', onConfirm);
                cancelBtn.addEventListener('click', onCancel);
                overlay.addEventListener('click', onCancel);
            });
        }

        // å¯¼å‡ºä¸ºé™æ€HTML
        function exportAsStaticHTML() {
            // æ‰“å¼€æ‰€æœ‰å¼¹çª—å¹¶å°†å…¶å†…å®¹å†…è”æ˜¾ç¤º
            document.querySelectorAll('.coord-popup, .battle-popup').forEach(popup => {
                popup.style.display = 'block';
                popup.style.position = 'static';
                popup.style.boxShadow = 'none';
                popup.style.margin = '10px 0';
                popup.style.maxWidth = '100%';
                popup.style.maxHeight = 'none';

                // ç§»é™¤å…³é—­æŒ‰é’®
                const closeBtn = popup.querySelector('.close-btn');
                if (closeBtn) closeBtn.style.display = 'none';
            });

            // ç¦ç”¨æ‰€æœ‰äº¤äº’å…ƒç´ 
            document.querySelectorAll('.coords-cell, .has-battle-events').forEach(cell => {
                cell.style.cursor = 'default';
            });

            // æ·»åŠ é™æ€æ¨¡å¼ç±»
            document.body.classList.add('static-mode');
            isStaticMode = true;

            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            alert("é¡µé¢å·²è½¬æ¢ä¸ºé™æ€æ¨¡å¼ï¼Œè¯·ä½¿ç”¨æµè§ˆå™¨çš„\"å¦å­˜æ–°æ¡£\"åŠŸèƒ½(Ctrl+S)ä¿å­˜ç½‘é¡µã€‚");
        }

        // æ¢å¤äº¤äº’æ¨¡å¼
        function restoreInteractiveMode() {
            // éšè—æ‰€æœ‰å¼¹çª—
            document.querySelectorAll('.coord-popup, .battle-popup').forEach(popup => {
                popup.style.display = '';
                popup.style.position = '';
                popup.style.boxShadow = '';
                popup.style.margin = '';
                popup.style.maxWidth = '';
                popup.style.maxHeight = '';

                // æ¢å¤å…³é—­æŒ‰é’®
                const closeBtn = popup.querySelector('.close-btn');
                if (closeBtn) closeBtn.style.display = '';
            });

            // æ¢å¤äº¤äº’å…ƒç´ 
            document.querySelectorAll('.coords-cell.has-coords, .has-battle-events').forEach(cell => {
                cell.style.cursor = 'pointer';
            });

            // ç§»é™¤é™æ€æ¨¡å¼ç±»
            document.body.classList.remove('static-mode');
            isStaticMode = false;

            // é‡æ–°åˆå§‹åŒ–å¼¹çª—
            if (window.setupCoordPopups) {
                setupCoordPopups();
            }
        }

        // å¤„ç†Pé”®æŒ‰ä¸‹äº‹ä»¶
        function handlePKey() {
            if (isStaticMode) {
                // é™æ€æ¨¡å¼ä¸‹ç›´æ¥æ¢å¤äº¤äº’æ¨¡å¼
                restoreInteractiveMode();
            } else {
                // äº¤äº’æ¨¡å¼ä¸‹è¯¢é—®ç”¨æˆ·æ˜¯å¦å¯¼å‡º
                showCustomConfirm(
                    "å¯¼å‡ºé™æ€æŠ¥å‘Š",
                    "æ˜¯å¦æ˜¾ç¤ºå¡æ­»ç‚¹å¹¶è½¬æ¢ä¸ºé™æ€æ¨¡å¼ä»¥ä¾¿å¯¼å‡ºæ–‡ä»¶ï¼Ÿ\n\nè½¬æ¢ä¸ºé™æ€æ¨¡å¼åï¼Œè¯·ä½¿ç”¨æµè§ˆå™¨çš„\"å¦å­˜ä¸º\"åŠŸèƒ½ä¿å­˜ç½‘é¡µã€‚"
                ).then(confirmed => {
                    if (confirmed) {
                        exportAsStaticHTML();
                    }
                });
            }
        }

        // åœ¨æ–‡ä»¶è§£æå‰é‡ç½®æ—¶é—´æˆ³è¿½è¸ª
        function resetTimeTracker() {
            lastValidTime = null;
        }
        const parsingContext = {
            activeGroups: new Map(),
            activeTasks: new Map(),
            allGroups: []
        };

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå¸®åŠ©æç¤º
        window.onload = function () {
            const now = new Date();
            const currentHour = now.getHours();
            const minutes = now.getMinutes();
            if ((currentHour < 6) || (currentHour === 6 && minutes <= 30)) {
                document.body.classList.add('dark-theme');
            }

            // æ˜¾ç¤ºå¸®åŠ©æç¤º
            const helpIndicator = document.getElementById('helpIndicator');
            helpIndicator.classList.add('visible');

            // 5ç§’åéšè—å¸®åŠ©æç¤º
            setTimeout(() => {
                helpIndicator.classList.remove('visible');
            }, 5000);

            // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            const isMobileDevice = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const hasTouchScreen = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

            // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ï¼Œæ·»åŠ ç§»åŠ¨è®¾å¤‡ç±»å¹¶æ˜¾ç¤ºæ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
            if (isMobileDevice || hasTouchScreen) {
                document.body.classList.add('mobile-device');
                document.getElementById('fileUploadContainer').style.display = 'block';
            }

            // è®¾ç½®æ–‡ä»¶ä¸Šä¼ æŒ‰é’®äº‹ä»¶
            document.getElementById('fileUploadBtn').addEventListener('click', function () {
                document.getElementById('fileInput').click();
            });

            // å¤„ç†æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        };

        // å¤„ç†æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        async function handleFileSelect(e) {
            const files = Array.from(e.target.files)
                .filter(f => f.name.startsWith('better-genshin-impact'))
                .sort((a, b) => parseDateFromFileName(a.name) - parseDateFromFileName(b.name));

            if (files.length === 0) {
                alert('è¯·é€‰æ‹©BetterGIæ—¥å¿—æ–‡ä»¶ï¼ˆæ–‡ä»¶åä»¥better-genshin-impactå¼€å¤´ï¼‰');
                return;
            }

            parsingContext.activeGroups.clear();
            parsingContext.activeTasks.clear();
            parsingContext.allGroups = [];

            try {
                resetTimeTracker();
                document.getElementById('dropZone').innerHTML = '<div class="loading">è§£æä¸­...</div>';
                document.getElementById('dropZone').className = 'has-content';

                for (const file of files) {
                    const content = await readFileAsText(file);
                    parseLog(content, parseDateFromFileName(file.name));
                }

                const result = finalizeParsing();
                document.getElementById('dropZone').innerHTML = generateHTML(result);
                setupCoordPopups();
                document.querySelectorAll('.group-header').forEach((el, i) => {
                    el.onclick = () => {
                        el.classList.toggle('collapsed');
                        document.getElementById(`group-${i}`).classList.toggle('collapsed');
                    };
                });

                // åº”ç”¨åˆå§‹æ˜¾ç¤ºçŠ¶æ€
                updateTimeColumnsVisibility();
                updateStatsColumnsVisibility();
                updateTableFormat();
                setupRowHighlight();

                // æ ‡è®°å·²æœ‰æ—¥å¿—æ•°æ®
                hasLogData = true;
            } catch (e) {
                document.getElementById('dropZone').innerHTML = `<div class="error">è§£æå¤±è´¥ï¼š${e.message}</div>`;
            }
        }

        // è¯»å–æ–‡ä»¶å†…å®¹ä¸ºæ–‡æœ¬
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsText(file);
            });
        }


        // æ‹–æ”¾äº‹ä»¶å¤„ç†
        const dropZone = document.getElementById('dropZone');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', async e => {
            e.preventDefault();
            dropZone.style.backgroundColor = '';

            const files = Array.from(e.dataTransfer.files)
                .filter(f => f.name.startsWith('better-genshin-impact'))
                .sort((a, b) => parseDateFromFileName(a.name) - parseDateFromFileName(b.name));

            if (files.length === 0) return;

            parsingContext.activeGroups.clear();
            parsingContext.activeTasks.clear();
            parsingContext.allGroups = [];

            try {
                resetTimeTracker();
                dropZone.innerHTML = '<div class="loading">è§£æä¸­...</div>';

                for (const file of files) {
                    const content = await file.text();
                    parseLog(content, parseDateFromFileName(file.name));
                }

                const result = finalizeParsing();
                dropZone.className = 'has-content';
                dropZone.innerHTML = generateHTML(result);
                setupCoordPopups();
                document.querySelectorAll('.group-header').forEach((el, i) => {
                    el.onclick = () => {
                        el.classList.toggle('collapsed');
                        document.getElementById(`group-${i}`).classList.toggle('collapsed');
                    };
                });

                // åº”ç”¨åˆå§‹æ—¶é—´åˆ—æ˜¾ç¤ºçŠ¶æ€
                updateTimeColumnsVisibility();
                // åº”ç”¨åˆå§‹ç»Ÿè®¡åˆ—æ˜¾ç¤ºçŠ¶æ€
                updateStatsColumnsVisibility();
                // åº”ç”¨åˆå§‹è¡¨æ ¼æ ¼å¼
                updateTableFormat();

                // è®¾ç½®è¡Œé«˜äº®æ•ˆæœ
                setupRowHighlight();

                // æ ‡è®°å·²æœ‰æ—¥å¿—æ•°æ®
                hasLogData = true;
            } catch (e) {
                dropZone.innerHTML = `<div class="error">è§£æå¤±è´¥ï¼š${e.message}</div>`;
            }
        });

        // ä¿®æ”¹åæ ‡å¼¹çª—äº‹ä»¶å¤„ç†å‡½æ•°
        function setupCoordPopups() {
            const coordsCells = document.querySelectorAll('.coords-cell');
            const battleCells = document.querySelectorAll('.has-battle-events');
            let popupPositions = new WeakMap(); // å­˜å‚¨æ¯ä¸ªå¼¹çª—çš„ä½ç½®çŠ¶æ€
            let pinnedPopup = null;
            let isDragging = false;
            let dragOffsetX, dragOffsetY;
            let dragElement = null;
            const allPopups = []; // å­˜å‚¨æ‰€æœ‰å¼¹çª—å…ƒç´ 

            // æ·»åŠ åŒå‡»é‡ç½®åŠŸèƒ½
            let lastClickTime = 0;
            let clickTimeout = null;

            // å®šä½å¼¹çª—å‡½æ•°
            const positionPopup = (popup, cell) => {
                // å¦‚æœå·²æœ‰ä½ç½®è®°å½•ï¼Œä½¿ç”¨è®°å½•çš„ä½ç½®
                if (popupPositions.has(popup)) {
                    const pos = popupPositions.get(popup);
                    popup.style.left = pos.x + 'px';
                    popup.style.top = pos.y + 'px';
                    return;
                }

                // å¦åˆ™å®šä½åœ¨å•å…ƒæ ¼ä¸­é—´
                const cellRect = cell.getBoundingClientRect();
                const popupRect = popup.getBoundingClientRect();

                // è®¡ç®—ä½ç½® - å•å…ƒæ ¼ä¸­é—´
                let left = cellRect.left + (cellRect.width - popupRect.width) / 2;
                let top = cellRect.top + (cellRect.height - popupRect.height) / 2;

                // ç¡®ä¿ä¸ä¼šè¶…å‡ºè§†å£
                if (left < 5) left = 5;
                if (top < 5) top = 5;
                if (left + popupRect.width > window.innerWidth) {
                    left = window.innerWidth - popupRect.width - 5;
                }
                if (top + popupRect.height > window.innerHeight) {
                    top = window.innerHeight - popupRect.height - 5;
                }

                popup.style.left = left + 'px';
                popup.style.top = top + 'px';

                // å­˜å‚¨åˆå§‹ä½ç½®
                popupPositions.set(popup, { x: left, y: top });
            };

            // å¤„ç†åæ ‡å¼¹çª—å•å…ƒæ ¼
            coordsCells.forEach(cell => {
                const popup = cell.querySelector('.coord-popup');
                if (!popup) return;

                // åŒå‡»äº‹ä»¶å¤„ç†
                cell.addEventListener('dblclick', (e) => {
                    e.stopPropagation();

                    // é‡ç½®å¼¹çª—ä½ç½®
                    if (popup) {
                        // æ¸…é™¤ä½ç½®è®°å½•ï¼Œå¼ºåˆ¶é‡æ–°å®šä½åˆ°ä¸­é—´
                        popupPositions.delete(popup);
                        positionPopup(popup, cell);

                        // ç¡®ä¿å¼¹çª—å¯è§
                        popup.classList.add('visible');
                    }
                });

                // åªåœ¨æœ‰åæ ‡æ•°æ®æ—¶æ‰æ·»åŠ ç‚¹å‡»äº‹ä»¶
                if (cell.classList.contains('has-coords')) {
                    // ç‚¹å‡»å•å…ƒæ ¼å›ºå®š/å–æ¶ˆå›ºå®šå¼¹çª—
                    cell.addEventListener('click', (e) => {
                        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘å¼¹çª—çš„ç‚¹å‡»äº‹ä»¶
                        e.stopPropagation();

                        // å¿½ç•¥æ ‡é¢˜æ å’Œå…³é—­æŒ‰é’®çš„ç‚¹å‡»
                        if (e.target.closest('.coord-popup-header')) return;

                        if (popup.classList.contains('pinned')) {
                            // å–æ¶ˆå›ºå®š
                            popup.classList.remove('pinned');
                            cell.classList.remove('pinned');
                            pinnedPopup = null;

                            // å¦‚æœé¼ æ ‡ä¸åœ¨å•å…ƒæ ¼ä¸Šï¼Œéšè—å¼¹çª—
                            if (!cell.matches(':hover')) {
                                popup.classList.remove('visible');
                            }
                        } else {
                            // å›ºå®šå¼¹çª—
                            pinPopup(popup, cell);
                        }
                    });
                }

                // å›ºå®šå¼¹çª—å‡½æ•°
                const pinPopup = (popup, cell) => {
                    popup.classList.add('pinned');
                    cell.classList.add('pinned');
                    pinnedPopup = popup;

                    // ç¡®ä¿å¼¹çª—å¯è§
                    popup.classList.add('visible');

                    // å­˜å‚¨å½“å‰ä½ç½®
                    popupPositions.set(popup, {
                        x: parseInt(popup.style.left),
                        y: parseInt(popup.style.top)
                    });
                };

                // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå¼¹çª—ï¼ˆåªåœ¨æœ‰åæ ‡æ•°æ®æ—¶ï¼‰
                if (cell.classList.contains('has-coords')) {
                    cell.addEventListener('mouseenter', (e) => {
                        // å¦‚æœå·²æœ‰å…¶ä»–å¼¹çª—å›ºå®šï¼Œä¸åšå¤„ç†
                        if (pinnedPopup && pinnedPopup !== popup) return;

                        positionPopup(popup, cell);
                        popup.classList.add('visible');
                    });

                    cell.addEventListener('mouseleave', (e) => {
                        // æ£€æŸ¥é¼ æ ‡æ˜¯å¦ç§»åŠ¨åˆ°å¼¹çª—ä¸Š
                        if (popup.contains(e.relatedTarget)) return;

                        // å¦‚æœå¼¹çª—æœªå›ºå®šï¼Œéšè—å®ƒ
                        if (!popup.classList.contains('pinned')) {
                            popup.classList.remove('visible');
                        }
                    });
                }

                // å¼¹çª—é¼ æ ‡è¿›å…¥/ç¦»å¼€å¤„ç†
                popup.addEventListener('mouseenter', () => {
                    // é˜²æ­¢å•å…ƒæ ¼mouseleaveäº‹ä»¶è§¦å‘
                    popup._hovering = true;
                });

                popup.addEventListener('mouseleave', () => {
                    popup._hovering = false;

                    // å¦‚æœå¼¹çª—æœªå›ºå®šä¸”é¼ æ ‡ä¸åœ¨å•å…ƒæ ¼ä¸Šï¼Œéšè—å¼¹çª—
                    if (!popup.classList.contains('pinned') && !cell.matches(':hover')) {
                        popup.classList.remove('visible');
                    }
                });

                // åœ¨åˆ›å»ºå¼¹çª—åæ·»åŠ åˆ° allPopups
                if (popup) {
                    allPopups.push(popup);
                }

                // ç‚¹å‡»å…³é—­æŒ‰é’®
                const closeBtn = popup.querySelector('.close-btn');
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    popup.classList.remove('visible', 'pinned');
                    cell.classList.remove('pinned');
                    pinnedPopup = null;

                    // æ¸…é™¤ä½ç½®è®°å½•
                    popupPositions.delete(popup);
                });

                // æ ‡é¢˜æ æ‹–æ‹½åŠŸèƒ½ - ç§»åŠ¨æ—¶è‡ªåŠ¨å›ºå®š
                const header = popup.querySelector('.coord-popup-header');
                header.addEventListener('mousedown', (e) => {
                    if (e.target === closeBtn) return;

                    isDragging = true;
                    dragElement = popup;
                    const rect = popup.getBoundingClientRect();
                    dragOffsetX = e.clientX - rect.left;
                    dragOffsetY = e.clientY - rect.top;

                    // ç§»åŠ¨æ—¶è‡ªåŠ¨å›ºå®šå¼¹çª—
                    if (!popup.classList.contains('pinned')) {
                        pinPopup(popup, cell);
                    }

                    e.preventDefault();
                });

                // é˜»æ­¢å†…å®¹åŒºåŸŸçš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
                popup.addEventListener('click', (e) => {
                    e.stopPropagation();
                });

            });

            // å¤„ç†æˆ˜æ–—äº‹ä»¶å¼¹çª—å•å…ƒæ ¼
            battleCells.forEach(cell => {
                const popups = cell.querySelectorAll('.battle-popup');
                if (!popups || popups.length === 0) return;

                popups.forEach(popup => {
                    // åŒå‡»äº‹ä»¶å¤„ç†
                    cell.addEventListener('dblclick', (e) => {
                        e.stopPropagation();

                        // é‡ç½®å¼¹çª—ä½ç½®
                        if (popup) {
                            // æ¸…é™¤ä½ç½®è®°å½•ï¼Œå¼ºåˆ¶é‡æ–°å®šä½åˆ°ä¸­é—´
                            popupPositions.delete(popup);
                            positionPopup(popup, cell);

                            // ç¡®ä¿å¼¹çª—å¯è§
                            popup.classList.add('visible');
                        }
                    });

                    // ç‚¹å‡»å•å…ƒæ ¼å›ºå®š/å–æ¶ˆå›ºå®šå¼¹çª—
                    cell.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (e.target.closest('.battle-popup-header')) return;

                        if (popup.classList.contains('pinned')) {
                            popup.classList.remove('pinned');
                            cell.classList.remove('pinned');
                            pinnedPopup = null;
                            if (!cell.matches(':hover')) {
                                popup.classList.remove('visible');
                            }
                        } else {
                            pinPopup(popup, cell);
                        }
                    });

                    // å›ºå®šå¼¹çª—å‡½æ•°
                    const pinPopup = (popup, cell) => {
                        popup.classList.add('pinned');
                        cell.classList.add('pinned');
                        pinnedPopup = popup;
                        popup.classList.add('visible');
                        positionPopup(popup, cell);
                        popupPositions.set(popup, {
                            x: parseInt(popup.style.left),
                            y: parseInt(popup.style.top)
                        });
                    };

                    // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå¼¹çª—
                    cell.addEventListener('mouseenter', (e) => {
                        if (pinnedPopup && pinnedPopup !== popup) return;
                        positionPopup(popup, cell);
                        popup.classList.add('visible');
                    });

                    cell.addEventListener('mouseleave', (e) => {
                        if (popup.contains(e.relatedTarget)) return;
                        if (!popup.classList.contains('pinned')) {
                            popup.classList.remove('visible');
                        }
                    });

                    // å¼¹çª—é¼ æ ‡è¿›å…¥/ç¦»å¼€å¤„ç†
                    popup.addEventListener('mouseenter', () => {
                        popup._hovering = true;
                    });

                    popup.addEventListener('mouseleave', () => {
                        popup._hovering = false;
                        if (!popup.classList.contains('pinned') && !cell.matches(':hover')) {
                            popup.classList.remove('visible');
                        }
                    });

                    // æ·»åŠ åˆ°å…¨å±€å¼¹çª—åˆ—è¡¨
                    allPopups.push(popup);

                    // ç‚¹å‡»å…³é—­æŒ‰é’®
                    const closeBtn = popup.querySelector('.close-btn');
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        popup.classList.remove('visible', 'pinned');
                        cell.classList.remove('pinned');
                        pinnedPopup = null;
                        popupPositions.delete(popup);
                    });

                    // æ ‡é¢˜æ æ‹–æ‹½åŠŸèƒ½
                    const header = popup.querySelector('.battle-popup-header');
                    header.addEventListener('mousedown', (e) => {
                        if (e.target === closeBtn) return;
                        isDragging = true;
                        dragElement = popup;
                        const rect = popup.getBoundingClientRect();
                        dragOffsetX = e.clientX - rect.left;
                        dragOffsetY = e.clientY - rect.top;
                        if (!popup.classList.contains('pinned')) {
                            pinPopup(popup, cell);
                        }
                        e.preventDefault();
                    });

                    // é˜»æ­¢å†…å®¹åŒºåŸŸçš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
                    popup.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                });
            });

            // å…¨å±€é¼ æ ‡äº‹ä»¶å¤„ç†æ‹–æ‹½
            document.addEventListener('mousemove', (e) => {
                if (!isDragging || !dragElement) return;

                dragElement.style.left = (e.clientX - dragOffsetX) + 'px';
                dragElement.style.top = (e.clientY - dragOffsetY) + 'px';

                // æ›´æ–°ä½ç½®è®°å½•
                popupPositions.set(dragElement, {
                    x: parseInt(dragElement.style.left),
                    y: parseInt(dragElement.style.top)
                });
            });

            document.addEventListener('mouseup', () => {
                if (isDragging && dragElement) {
                    // æ›´æ–°ä½ç½®è®°å½•
                    popupPositions.set(dragElement, {
                        x: parseInt(dragElement.style.left),
                        y: parseInt(dragElement.style.top)
                    });
                }
                isDragging = false;
                dragElement = null;
            });

            // æ·»åŠ é‡ç½®å‡½æ•°
            function resetCoordPopups() {
                // å…³é—­æ‰€æœ‰å¯è§å¼¹çª—
                allPopups.forEach(popup => {
                    popup.classList.remove('visible', 'pinned');

                    // ç§»é™¤å•å…ƒæ ¼çš„å›ºå®šçŠ¶æ€
                    const cell = popup.closest('.coords-cell, .has-battle-events');
                    if (cell) {
                        cell.classList.remove('pinned');
                    }
                });

                // æ¸…é™¤ä½ç½®è®°å½•
                popupPositions = new WeakMap();
                pinnedPopup = null;

                // é‡æ–°å®šä½æ‰€æœ‰å¼¹çª—åˆ°å•å…ƒæ ¼ä¸­é—´
                coordsCells.forEach(cell => {
                    const popup = cell.querySelector('.coord-popup');
                    if (popup) { positionPopup(popup, cell); }
                });
                battleCells.forEach(cell => {
                    const popups = cell.querySelectorAll('.battle-popup');
                    popups.forEach(popup => positionPopup(popup, cell));
                });
            }

            // æš´éœ²é‡ç½®å‡½æ•°åˆ°å…¨å±€
            window.resetCoordPopups = resetCoordPopups;

            // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°å®šä½
            window.addEventListener('resize', () => {
                document.querySelectorAll('.coord-popup.visible, .battle-popup.visible').forEach(popup => {
                    // å¦‚æœå¼¹çª—æœ‰ä½ç½®è®°å½•ï¼Œè°ƒæ•´ä½ç½®ç¡®ä¿åœ¨è§†å£å†…
                    if (popupPositions.has(popup)) {
                        const pos = popupPositions.get(popup);
                        const popupRect = popup.getBoundingClientRect();

                        // æ£€æŸ¥ä½ç½®æ˜¯å¦åœ¨è§†å£å†…
                        let newLeft = pos.x;
                        let newTop = pos.y;

                        if (newLeft + popupRect.width > window.innerWidth) {
                            newLeft = window.innerWidth - popupRect.width - 5;
                        }
                        if (newTop + popupRect.height > window.innerHeight) {
                            newTop = window.innerHeight - popupRect.height - 5;
                        }
                        if (newLeft < 5) newLeft = 5;
                        if (newTop < 5) newTop = 5;

                        // æ›´æ–°ä½ç½®
                        popup.style.left = newLeft + 'px';
                        popup.style.top = newTop + 'px';

                        // æ›´æ–°ä½ç½®è®°å½•
                        popupPositions.set(popup, { x: newLeft, y: newTop });
                    } else {
                        // å¦‚æœæ²¡æœ‰ä½ç½®è®°å½•ï¼Œé‡æ–°å®šä½åˆ°å•å…ƒæ ¼ä¸­é—´
                        const cell = popup.closest('.coords-cell, .has-battle-events');
                        if (cell) {
                            positionPopup(popup, cell);
                        }
                    }
                });
            });
        }

        // æ–‡ä»¶å¤„ç†æµç¨‹
        async function processFiles(files) {
            return files
                .map(file => ({
                    file, // ä¿ç•™åŸå§‹Fileå¯¹è±¡
                    date: parseDateFromFileName(file.name)
                }))
                .sort((a, b) => a.date - b.date) // æŒ‰æ—¥æœŸä»æ–°åˆ°æ–°æ’åº
                .map(entry => ({
                    file: entry.file, // ç›´æ¥ä¼ é€’Fileå¯¹è±¡
                    date: entry.date
                }));
        }

        // ä»æ–‡ä»¶åè§£ææ—¥æœŸ
        function parseDateFromFileName(fileName) {
            const match = fileName.match(/(\d{4})(\d{2})(\d{2})/);
            if (match) {
                return new Date(
                    parseInt(match[1]),
                    parseInt(match[2]) - 1,
                    parseInt(match[3])
                );
            }
            return new Date(0); // æ— æ•ˆæ—¥æœŸç½®å‰
        }

        // æ—¥å¿—è§£æé€»è¾‘
        function parseLog(content, fileDate) {
            const lines = content.split('\n');
            let prevLine = "";
            let lastCoordForRevive = null; // ç”¨äºè¡€é‡æ¢å¤å®Œæˆçš„åæ ‡è·Ÿè¸ª
            let lastCoordForStuck = null;  // ç”¨äºç–‘ä¼¼å¡æ­»çš„åæ ‡è·Ÿè¸ª
            let battleCount = 0; // è‡ªåŠ¨æˆ˜æ–—è®¡æ•°å™¨

            lines.forEach(line => {
                // è§£æé…ç½®ç»„
                let match = line.match(/é…ç½®ç»„ "(.+?)" åŠ è½½å®Œæˆ/);
                if (match) {
                    const groupName = match[1];
                    let group = parsingContext.activeGroups.get(groupName) || {
                        name: groupName,
                        startTime: parseTime(prevLine, fileDate),
                        endTime: null,
                        tasks: [],
                        picks: new Map(),
                        lastActive: null
                    };
                    group.lastActive = parseTime(prevLine, fileDate);
                    parsingContext.activeGroups.set(groupName, group);
                    battleCount = 0; // é‡ç½®æˆ˜æ–—è®¡æ•°å™¨
                    lastCoordForRevive = null; // é‡ç½®åæ ‡è·Ÿè¸ª
                    lastCoordForStuck = null;  // é‡ç½®åæ ‡è·Ÿè¸ª
                }

                // match = line.match(/â†’ "ä»»åŠ¡ç»“æŸ"/);
                match = line.match(/é…ç½®ç»„ "(.+?)" æ‰§è¡Œç»“æŸ/);
                if (match) {
                    const group = parsingContext.activeGroups.get(match[1]);
                    if (group) {
                        group.endTime = parseTime(prevLine, fileDate);
                        parsingContext.allGroups.push(group);
                        parsingContext.activeGroups.delete(match[1]);
                    }
                }

                // è§£æä»»åŠ¡
                const currentGroup = Array.from(parsingContext.activeGroups.values()).pop();
                if (currentGroup) {
                    // æ£€æµ‹è‡ªåŠ¨æˆ˜æ–—å¼€å§‹
                    if (line.includes('æ‰§è¡Œ "è‡ªåŠ¨æˆ˜æ–—"')) {
                        battleCount++;
                    }

                    // match = line.match(/â†’ å¼€å§‹æ‰§è¡Œåœ°å›¾è¿½è¸ªä»»åŠ¡: "(.+?)"/);
                    // match = line.match(/â†’ å¼€å§‹æ‰§è¡Œè·¯å¾„è¿½è¸ªä»»åŠ¡: "(.+?)"/)
                    // match = line.match(/â†’ å¼€å§‹æ‰§è¡Œ(?:åœ°å›¾|è·¯å¾„)è¿½è¸ªä»»åŠ¡: "(.+?)"/);
                    // match = line.match(/â†’ å¼€å§‹æ‰§è¡Œ(?:åœ°å›¾|è·¯å¾„)è¿½è¸ªä»»åŠ¡: "(.+?)"|assets\/(.+?\.json)/);
                    // match = line.match(/â†’ å¼€å§‹æ‰§è¡Œ(?:åœ°å›¾|è·¯å¾„)è¿½è¸ªä»»åŠ¡: "(.+?)"|assets\/(.+?\.json)|å½“å‰é’“é±¼ç‚¹: (.+)/);
                    match = line.match(/â†’ å¼€å§‹æ‰§è¡Œ(?:åœ°å›¾|è·¯å¾„)è¿½è¸ªä»»åŠ¡: "(.+?)"|assets\/(.+?\.json)|å½“å‰é’“é±¼ç‚¹: (.+)|â†’ å¼€å§‹æ‰§è¡ŒJSè„šæœ¬: "(.+?)"/);
                    if (match) {
                        const taskName = match[1] || match[2] || match[3] || match[4];
                        const task = {
                            name: taskName,
                            startTime: parseTime(prevLine, fileDate),
                            endTime: null,
                            faults: {
                                revive: 0,
                                teleport: 0,
                                retry: 0,
                                retryDetail: 0,
                                too_far_skip: 0,
                                timeout: 0
                            },
                            picks: new Map(),
                            reviveEvents: [], // æ–°å¢ï¼šå¤æ´»äº‹ä»¶
                            timeoutEvents: [], // æ–°å¢ï¼šè¶…æ—¶äº‹ä»¶
                            maxBattleCount: 0 // è®°å½•æœ€å¤§æˆ˜æ–—æ¬¡æ•°
                        };
                        currentGroup.tasks.push(task);
                        parsingContext.activeTasks.set(task.name, task);
                        battleCount = 0; // æ–°ä»»åŠ¡é‡ç½®æˆ˜æ–—è®¡æ•°å™¨
                    }

                    match = line.match(/â†’ è„šæœ¬æ‰§è¡Œç»“æŸ: "(.+?)"/);
                    if (match) {
                        const task = parsingContext.activeTasks.get(match[1]);
                        if (task) {
                            task.endTime = parseTime(prevLine, fileDate);
                            parsingContext.activeTasks.delete(task.name);
                        }
                    }

                    // ç»Ÿè®¡ä¿¡æ¯
                    const currentTask = currentGroup.tasks[currentGroup.tasks.length - 1];
                    if (currentTask) {
                        // æ›´æ–°æœ€å¤§æˆ˜æ–—æ¬¡æ•°
                        if (battleCount > currentTask.maxBattleCount) {
                            currentTask.maxBattleCount = battleCount;
                        }

                        // æ•è·åæ ‡ä¿¡æ¯ï¼ˆæ— è®ºæ˜¯å¦åœ¨å¡æ­»å‰ï¼‰
                        const coordMatch = line.match(/ç²—ç•¥æ¥è¿‘é€”ç»ç‚¹ï¼Œä½ç½®\("(-?\d+(?:\.\d+)?)","(-?\d+(?:\.\d+)?)"\)/);
                        if (coordMatch) {
                            // åŒæ—¶æ›´æ–°ä¸¤ä¸ªåæ ‡è·Ÿè¸ªå™¨
                            lastCoordForRevive = { x: coordMatch[1], y: coordMatch[2] };
                            lastCoordForStuck = { x: coordMatch[1], y: coordMatch[2] };
                        }

                        // if (line.includes("å‰å¾€ä¸ƒå¤©ç¥åƒå¤æ´»")) currentTask.faults.revive++;

                        // å¤æ´»äº‹ä»¶
                        if (line.includes("è¡€é‡æ¢å¤å®Œæˆã€‚")) {
                            currentTask.faults.revive++;
                            // è®°å½•å¤æ´»äº‹ä»¶å¯¹åº”çš„æˆ˜æ–—åºå·å’Œåæ ‡
                            currentTask.reviveEvents.push({
                                battleCount: battleCount,
                                coord: lastCoordForRevive ? { x: lastCoordForRevive.x, y: lastCoordForRevive.y } : null
                            });
                            // é‡ç½®å¤æ´»åæ ‡è·Ÿè¸ªå™¨
                            lastCoordForRevive = null;
                        }

                        if (line.includes("å½“å‰è§’è‰²è¡€é‡è¿‡ä½")) currentTask.faults.revive = currentTask.faults.revive - 0.9;
                        if (line.match(/ä¼ é€å¤±è´¥ï¼Œé‡è¯• (\d+) æ¬¡/))
                            currentTask.faults.teleport = parseInt(RegExp.$1);
                        // if (line.includes("é‡è¯•ä¸€æ¬¡è·¯çº¿")) currentTask.faults.retry++;
                        if (line.includes("è®°å½•æ¢å¤ç‚¹ä½ï¼Œåœ°å›¾è¿½è¸ªå°†åˆ°è¾¾ä¸Šæ¬¡ç‚¹ä½ä¹‹å‰å°†è·³è¿‡èµ°è·¯ä¹‹å¤–çš„æ“ä½œ")) currentTask.faults.retry++;
                        if (line.includes("ç–‘ä¼¼å¡æ­»ï¼Œå°è¯•è„±ç¦»...")) {
                            currentTask.faults.retryDetail++;

                            // ä½¿ç”¨æœ€è¿‘æ•è·çš„åæ ‡
                            if (lastCoordForStuck) {
                                if (!currentTask.faults.coords) {
                                    currentTask.faults.coords = [];
                                }
                                currentTask.faults.coords.push(lastCoordForStuck);
                                // é‡ç½®å¡æ­»åæ ‡è·Ÿè¸ªå™¨
                                lastCoordForStuck = null;
                            }
                        }
                        // if (line.includes("è·ç¦»è¿‡è¿œï¼Œè·³è¿‡è·¯å¾„ç‚¹")) currentTask.faults.too_far_skip++;
                        if (line.includes("è·ç¦»è¿‡è¿œ") && /\(\d+\.?\d*,\d+\.?\d*\)->\(\d+\.?\d*,\d+\.?\d*\)=\d+\.?\d*ï¼Œè·³è¿‡è·¯å¾„ç‚¹/)
                            currentTask.faults.too_far_skip++;

                        // æˆ˜æ–—è¶…æ—¶äº‹ä»¶
                        if (line.includes("æˆ˜æ–—è¶…æ—¶")) {
                            currentTask.faults.timeout++;
                            // è®°å½•è¶…æ—¶äº‹ä»¶å¯¹åº”çš„æˆ˜æ–—åºå·
                            currentTask.timeoutEvents.push(battleCount);
                        }
                        // æ£€æµ‹è„šæœ¬æœªæ­£å¸¸èµ°å®Œçš„æç¤º
                        // æ£€æµ‹ç‰¹å®šäº‹ä»¶å¹¶è®°å½•
                        if (line.includes("å¼€å§‹è‡ªåŠ¨é¢†å–æ´¾é£ä»»åŠ¡ï¼")) {
                            currentTask.hasDispatch = true; // æ ‡è®°æœ‰æ´¾é£ä»»åŠ¡
                        }
                        if (line.includes("å¿«æ·é”®è§¦å‘æš‚åœï¼Œç­‰å¾…è§£é™¤")) {
                            currentTask.hasPause = true; // æ ‡è®°æœ‰æš‚åœäº‹ä»¶
                        }
                        if (line.includes("æ­¤è¿½è¸ªè„šæœ¬æœªæ­£å¸¸èµ°å®Œï¼")) {
                            currentTask.abnormalEnd = true; // æ ‡è®°å¼‚å¸¸ç»“æŸ
                        }
                        const pickMatch = line.match(/äº¤äº’æˆ–æ‹¾å–ï¼š"(.+?)"/);

                        if (pickMatch) {
                            currentTask.picks.set(pickMatch[1], (currentTask.picks.get(pickMatch[1]) || 0) + 1);
                            currentGroup.picks.set(pickMatch[1], (currentGroup.picks.get(pickMatch[1]) || 0) + 1);
                        }
                    }
                }
                prevLine = line;
            });
        }

        function finalizeParsing() {
            // å¤„ç†æœªå®Œæˆä»»åŠ¡
            parsingContext.activeTasks.forEach(task => {
                task.endTime = task.startTime;
            });

            // å¤„ç†æœªå®Œæˆé…ç½®ç»„
            parsingContext.activeGroups.forEach(group => {
                group.endTime = group.tasks.length > 0
                    ? group.tasks[group.tasks.length - 1].startTime
                    : group.startTime;
                parsingContext.allGroups.push(group);
            });

            return parsingContext.allGroups.sort((a, b) =>
                (b.endTime || b.startTime) - (a.endTime || a.startTime)
            );
        }

        function formatDuration(seconds) {
            if (seconds < 0) return "æ—¶é—´å¼‚å¸¸"; // å¤„ç†è´Ÿå€¼æƒ…å†µ

            const days = Math.floor(seconds / 86400);
            seconds %= 86400;
            const hours = Math.floor(seconds / 3600);
            seconds %= 3600;
            const minutes = Math.floor(seconds / 60);
            const sec = seconds % 60;

            let result = [];
            if (days > 0) result.push(`${days}å¤©`);
            if (hours > 0) result.push(`${hours}å°æ—¶`);
            if (minutes > 0) result.push(`${minutes}åˆ†é’Ÿ`);
            if (sec > 0 || result.length === 0) {
                result.push(sec % 1 === 0 ? `${sec}ç§’` : `${sec.toFixed(2)}ç§’`);
            }

            return result.join('') || "0ç§’";
        }

        // æ–°å¢è€—æ—¶è®¡ç®—å‡½æ•°
        function calculateDuration(start, end) {
            if (!start || !end) return 'è¿›è¡Œä¸­';
            const diff = (end.getTime() - start.getTime()) / 1000;
            return formatDuration(diff);
        }

        // æ–°å¢é…ç½®ç»„è€—æ—¶è®¡ç®—
        function calculateGroupDuration(group) {
            if (!group.startTime || !group.endTime) return 'è¿›è¡Œä¸­';
            const diff = (group.endTime.getTime() - group.startTime.getTime()) / 1000;
            return formatDuration(diff);
        }

        // æ–°çš„è€—æ—¶è®¡ç®—å‡½æ•°
        function formatDuration(totalSeconds) {
            if (totalSeconds <= 0) return "0ç§’";

            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            let result = "";

            if (hours > 0) {
                result += `${hours}å°æ—¶`;
            }

            if (minutes > 0 || hours > 0) {
                result += `${minutes}åˆ†é’Ÿ`;
            }

            if (seconds > 0 || (hours === 0 && minutes === 0)) {
                if (seconds % 1 === 0) {
                    result += `${Math.floor(seconds)}ç§’`;
                } else {
                    result += `${seconds.toFixed(2)}ç§’`;
                }
            }

            return result || "0ç§’";
        }

        // æ—¶é—´è§£æè¾…åŠ©å‡½æ•°
        function parseTime(line, fileDate) {
            const timeMatch = line?.match(/\[(\d{2}):(\d{2}):(\d{2})\.\d+\]/);
            if (!timeMatch) return null;

            // åˆ›å»ºåŸºç¡€æ—¶é—´å¯¹è±¡
            const baseDate = new Date(fileDate);
            const hours = parseInt(timeMatch[1]);
            const minutes = parseInt(timeMatch[2]);
            const seconds = parseInt(timeMatch[3]);

            // æ™ºèƒ½æ—¥æœŸæ¨ç®—
            const currentTime = new Date(baseDate);
            currentTime.setHours(hours, minutes, seconds);

            // å¤„ç†è·¨æ—¥æƒ…å†µ
            if (lastValidTime && currentTime < lastValidTime) {
                // å¦‚æœæ—¶é—´å›é€€è¶…è¿‡4å°æ—¶ï¼Œè§†ä¸ºæ¬¡æ—¥ï¼ˆå…¼å®¹å‡Œæ™¨4ç‚¹åˆ·æ–°æœºåˆ¶ï¼‰
                if ((lastValidTime - currentTime) > 4 * 60 * 60 * 1000) {
                    currentTime.setDate(currentTime.getDate() + 1);
                }
            }

            lastValidTime = currentTime;
            return currentTime;
        }

        // é‡å†™å…¨å±åŠŸèƒ½ - ä½¿ç”¨æ›´å¯é çš„æ–¹æ³•
        function toggleFullScreen() {
            const doc = window.document;
            const docEl = doc.documentElement;

            // æ£€æŸ¥å½“å‰å…¨å±çŠ¶æ€
            const isFullScreen =
                doc.fullscreenElement ||
                doc.webkitFullscreenElement ||
                doc.mozFullScreenElement ||
                doc.msFullscreenElement;

            // åˆ‡æ¢å…¨å±çŠ¶æ€
            if (!isFullScreen) {
                // è¿›å…¥å…¨å±
                if (docEl.requestFullscreen) {
                    docEl.requestFullscreen();
                } else if (docEl.mozRequestFullScreen) { // Firefox
                    docEl.mozRequestFullScreen();
                } else if (docEl.webkitRequestFullscreen) { // Chrome, Safari and Opera
                    docEl.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                } else if (docEl.msRequestFullscreen) { // IE/Edge
                    docEl.msRequestFullscreen();
                }
            } else {
                // é€€å‡ºå…¨å±
                if (doc.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { // Firefox
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { // IE/Edge
                    document.msExitFullscreen();
                }
            }
        }

        // åˆ‡æ›å…¨å±æ¨¡å¼
        function changeFullScreen() {
            // åˆ¤æ–­å½“å‰æ˜¯å¦å…¨å±
            if (!document.fullscreenElement) {
                // è¿›å…¥å…¨å±ï¼ˆå…¼å®¹ä¸åŒæµè§ˆå™¨ï¼‰
                const element = document.documentElement;
                if (element.requestFullscreen) {
                    element.requestFullscreen().catch(err => {
                        console.error(`å…¨å±è¯·æ±‚é”™è¯¯: ${err.message}`);
                    });
                } else if (element.mozRequestFullScreen) { // Firefox
                    element.mozRequestFullScreen();
                } else if (element.webkitRequestFullscreen) { // Chrome/Safari
                    element.webkitRequestFullscreen();
                } else if (element.msRequestFullscreen) { // IE/Edge
                    element.msRequestFullscreen();
                }
            } else {
                // é€€å‡ºå…¨å±ï¼ˆå…¼å®¹ä¸åŒæµè§ˆå™¨ï¼‰
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) { // Firefox
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { // Chrome/Safari
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { // IE/Edge
                    document.msExitFullscreen();
                }
            }
        }

        // HTMLç”Ÿæˆé€»è¾‘
        function generateHTML(groups) {
            if (useLegacyFormat) {
                return generateLegacyFormatHTML(groups);
            } else {
                return generateNewFormatHTML(groups);
            }
        }

        // æ—§ç‰ˆæ ¼å¼HTMLç”Ÿæˆ
        function generateNewFormatHTML(groups) {
            let html = '<div style="width: 100%;">';

            groups.forEach((group, index) => {
                html += `
                <div class="group-container">
                <div class="group-header" data-group-index="${index}">
                    <span class="arrow">â–¶</span>
            <h2>é…ç½®ç»„ï¼š${group.name} (${formatDateTime(group.startTime)} - ${group.endTime ? `${formatDateTime(group.endTime)}) <span style="font-size:14px;color:#666;margin-left:10px;">è€—æ—¶${calculateGroupDuration(group)}</span>` : 'è¿›è¡Œä¸­)'}</h2>
            </div>
            <div class="collapsible" id="group-${index}">
            <table>
                <tr>
                    <th data-sort-type="string">ä»»åŠ¡åç§°</th>
                    <th class="column-start-time">å¼€å§‹æ—¶é—´</th>
                    <th class="column-end-time">ç»“æŸæ—¶é—´</th>
                    <th data-sort-type="number">è€—æ—¶</th>
                    <th class="column-revive">å¤æ´»æ¬¡æ•°</th>
                    <th class="column-retry">é‡è¯•æ¬¡æ•°</th>
                    <th class="column-retry-detail">ç–‘ä¼¼å¡æ­»</th>
                    <th class="column-too-far-skip">è¿‡è¿œè·³è¿‡</th>
                    <th class="column-timeout">æˆ˜æ–—è¶…æ—¶</th>
                    <th class="column-teleport">ä¼ é€å¤±è´¥</th>
                    <th class="column-picks">æ‹¾å–ç‰©</th>
                </tr>`;

                group.tasks.forEach(task => {

                    const hasCoords = task.faults.coords && task.faults.coords.length > 0;

                    // ç”Ÿæˆå¤æ´»äº‹ä»¶å¼¹çª—
                    let revivePopupHTML = '';
                    let hasReviveEvents = false;
                    if (task.reviveEvents && task.reviveEvents.length > 0) {
                        hasReviveEvents = true;
                        revivePopupHTML = '<div class="battle-popup">';
                        revivePopupHTML += '<div class="battle-popup-header">';
                        revivePopupHTML += '<div class="battle-popup-title">å¤æ´»äº‹ä»¶è¯¦ç»†</div>';
                        revivePopupHTML += '<span class="close-btn">Ã—</span>';
                        revivePopupHTML += '</div>';
                        revivePopupHTML += '<div class="battle-popup-content">';

                        // æŒ‰battleCountåˆ†ç»„
                        const eventsByBattleCount = {};
                        task.reviveEvents.forEach(event => {
                            if (!eventsByBattleCount[event.battleCount]) {
                                eventsByBattleCount[event.battleCount] = [];
                            }
                            eventsByBattleCount[event.battleCount].push(event);
                        });

                        // å¤„ç†æˆ˜æ–—å‰çš„å¤æ´»äº‹ä»¶ï¼ˆbattleCountä¸º0ï¼‰
                        if (eventsByBattleCount[0] && eventsByBattleCount[0].length > 0) {
                            eventsByBattleCount[0].forEach(event => {
                                const coordText = event.coord ? `(X=${event.coord.x}, Y=${event.coord.y})` : '';
                                revivePopupHTML += `<div class="battle-item">${coordText}</div>`;
                            });
                        }

                        // ç”Ÿæˆå®Œæ•´çš„æˆ˜æ–—åºåˆ—ï¼ˆä»1åˆ°æœ€å¤§æˆ˜æ–—æ¬¡æ•°ï¼‰
                        for (let i = 1; i <= task.maxBattleCount; i++) {
                            const events = eventsByBattleCount[i] || [];

                            if (events.length > 0) {
                                // æœ‰å¤æ´»äº‹ä»¶ï¼Œæ˜¾ç¤ºåæ ‡
                                const coords = events.map(e => e.coord ? `(X=${e.coord.x}, Y=${e.coord.y})` : '').filter(text => text);
                                const coordText = coords.length > 0 ? 'ï¼š' + coords.join('ã€') : '';
                                revivePopupHTML += `<div class="battle-item">${i}${coordText}</div>`;
                            } else {
                                // æ— å¤æ´»äº‹ä»¶ï¼Œåªæ˜¾ç¤ºåºå·
                                revivePopupHTML += `<div class="battle-item">${i}</div>`;
                            }
                        }

                        revivePopupHTML += '</div></div>';
                    }

                    // ç”Ÿæˆåæ ‡å¼¹çª—HTML
                    let coordPopupHTML = '';
                    if (hasCoords) {
                        coordPopupHTML = '<div class="coord-popup">';
                        coordPopupHTML += '<div class="coord-popup-header">';
                        coordPopupHTML += '<div class="coord-popup-title">å¡æ­»ç‚¹åæ ‡</div>';
                        coordPopupHTML += '<span class="close-btn">Ã—</span>';
                        coordPopupHTML += '</div>';
                        coordPopupHTML += '<div class="coord-popup-content">';

                        task.faults.coords.forEach((coord, idx) => {
                            coordPopupHTML += `<div class="coord-item">`;
                            coordPopupHTML += `<strong>#${idx + 1}</strong><br>`;
                            coordPopupHTML += `X: ${coord.x}<br>Y: ${coord.y}`;
                            coordPopupHTML += '</div>';
                        });

                        coordPopupHTML += '</div></div>';
                    }

                    // ç”Ÿæˆè¶…æ—¶äº‹ä»¶å¼¹çª—
                    let timeoutPopupHTML = '';
                    let hasTimeoutEvents = false;
                    if (task.timeoutEvents && task.timeoutEvents.length > 0) {
                        hasTimeoutEvents = true;
                        timeoutPopupHTML = '<div class="battle-popup">';
                        timeoutPopupHTML += '<div class="battle-popup-header">';
                        timeoutPopupHTML += '<div class="battle-popup-title">è¶…æ—¶äº‹ä»¶è¯¦ç»†</div>';
                        timeoutPopupHTML += '<span class="close-btn">Ã—</span>';
                        timeoutPopupHTML += '</div>';
                        timeoutPopupHTML += '<div class="battle-popup-content">';

                        // ç”Ÿæˆå®Œæ•´çš„æˆ˜æ–—åºåˆ—ï¼ˆä»1åˆ°æœ€å¤§æˆ˜æ–—æ¬¡æ•°ï¼‰
                        for (let i = 1; i <= task.maxBattleCount; i++) {
                            const hasEvent = task.timeoutEvents.includes(i);
                            timeoutPopupHTML += `<div class="battle-item">${i}${hasEvent ? '(X)' : ''}</div>`;
                        }

                        timeoutPopupHTML += '</div></div>';
                    }

                    // è®¾ç½®å•å…ƒæ ¼ç±» - åªåœ¨æœ‰äº‹ä»¶æ—¶æ·»åŠ å¯ç‚¹å‡»ç±»
                    const reviveCellClass = hasReviveEvents ? 'has-battle-events' : 'no-events';
                    const timeoutCellClass = hasTimeoutEvents ? 'has-battle-events' : 'no-events';

                    // åˆ¤æ–­æ˜¯å¦éœ€è¦å°†ä»»åŠ¡åå’Œè€—æ—¶æ ‡çº¢
                    const shouldHighlight =
                        task.faults.retry > 0 &&
                        task.faults.retryDetail === 0 &&
                        task.faults.revive === 0;

                    // æ ¼å¼åŒ–reviveå€¼ï¼šæ•´æ•°æ˜¾ç¤ºæ•´æ•°ï¼Œå°æ•°æ˜¾ç¤ºä¸¤ä½å°æ•°
                    let reviveDisplay = '';
                    if (task.faults.revive !== 0) {
                        if (Number.isInteger(task.faults.revive)) {
                            reviveDisplay = task.faults.revive;
                        } else {
                            // ç¡®ä¿å°æ•°éƒ¨åˆ†æœ‰ä¸¤ä½
                            reviveDisplay = task.faults.revive.toFixed(2);
                        }
                    }

                    // è®¡ç®—ä»»åŠ¡è€—æ—¶
                    const duration = calculateDuration(task.startTime, task.endTime);

                    // å•å…ƒæ ¼ç±» - å¦‚æœæœ‰åæ ‡æ•°æ®æ·»åŠ  has-coords ç±»
                    const cellClass = hasCoords ? 'coords-cell has-coords' : 'coords-cell';

                    // ç”Ÿæˆæ‹¾å–ç‰©æ˜¾ç¤ºæ–‡æœ¬
                    let picksText = formatPicks(task.picks);

                    // æŒ‰é¡ºåºæ·»åŠ æç¤ºæ–‡æœ¬
                    const alerts = [];

                    // 1. å¿«æ·é”®æš‚åœ
                    if (task.hasPause) {
                        alerts.push('<span class="pause-alert">å¿«æ·é”®æš‚åœ</span>');
                    }

                    // 2. é¢†å–æ´¾é£ä»»åŠ¡
                    if (task.hasDispatch) {
                        alerts.push('<span class="dispatch-alert">é¢†å–æ´¾é£ä»»åŠ¡</span>');
                    }

                    // 3. è„šæœ¬æœªæ­£å¸¸èµ°å®Œ
                    if (task.abnormalEnd) {
                        alerts.push('<span class="abnormal-alert">è„šæœ¬æœªæ­£å¸¸èµ°å®Œ</span>');
                    }

                    // å¦‚æœæœ‰æç¤ºï¼Œæ·»åŠ åˆ°æ‹¾å–ç‰©æ–‡æœ¬
                    if (alerts.length > 0) {
                        if (picksText === 'æ— ') {
                            picksText = alerts.join('<br>');
                        } else {
                            picksText += '<br>' + alerts.join('<br>');
                        }
                    }

                    html += `
                <tr>
                    <td class="${shouldHighlight ? 'task-name-red' : ''}">${task.name}</td>
                    <td class="column-start-time">${formatDateTime(task.startTime)}</td>
                    <td class="column-end-time">${task.endTime ? formatDateTime(task.endTime) : 'è¿›è¡Œä¸­'}</td>
                    <td class="${shouldHighlight ? 'duration-red' : ''}">${duration}</td>
                    <td class="column-revive ${reviveCellClass} ${task.faults.revive >= 2 ? 'red' : ''}">
                        ${reviveDisplay}
                        ${revivePopupHTML}
                    </td>
                    <td class="column-retry ${task.faults.retry >= 2 ? 'red' : ''}">${task.faults.retry == 0 ? '' : task.faults.retry}</td>
                    <td class="column-retry-detail ${cellClass} ${task.faults.retryDetail >= 2 ? '' : ''}">
                        ${task.faults.retryDetail == 0 ? '' : task.faults.retryDetail}
                        ${coordPopupHTML}
                    </td>
                    <td class="column-too-far-skip ${task.faults.too_far_skip >= 2 ? 'red' : 'red'}">${task.faults.too_far_skip == 0 ? '' : task.faults.too_far_skip}</td>
                    <td class="column-timeout ${timeoutCellClass} ${task.faults.timeout >= 1 ? 'red' : ''}">
                        ${task.faults.timeout == 0 ? '' : task.faults.timeout}
                        ${timeoutPopupHTML}
                    </td>
                    <td class="column-teleport ${task.faults.teleport >= 3 ? 'red' : ''}">${task.faults.teleport == 0 ? '' : task.faults.teleport}</td>
                        <td class="column-picks">${picksText}</td>
                    </tr>`;
                });

                html += `
            <tr>
                <td colspan="11" class="column-picks">
                    <strong>æ‹¾å–ç‰©æ€»è®¡ï¼š</strong>
                    ${formatPicks(group.picks)}
                </td>
            </tr>
            </table>
            </div>
            </div>`;
            });

            html += '</div>';
            return html;
        }

        // æ–°ç‰ˆæ ¼å¼HTMLç”Ÿæˆ
        function generateLegacyFormatHTML(groups) {
            let html = '<div class="legacy-format" style="width: 100%;">';

            groups.forEach((group, index) => {
                html += `
                <div class="group-container">
                <div class="group-header" data-group-index="${index}">
                <span class="arrow">â–¶</span>
                <h2>é…ç½®ç»„ï¼š${group.name} (${formatDateTime(group.startTime)} - ${group.endTime ? `${formatDateTime(group.endTime)}) <span style="font-size:14px;color:#666;margin-left:10px;">è€—æ—¶${calculateGroupDuration(group)}</span>` : 'è¿›è¡Œä¸­)'}</h2>
                </div>
                <div class="collapsible" id="group-${index}">
                <div class="sticky-table">
                <table>
                    <thead>
                    <tr class="sticky-header">
                        <th data-sort-type="string">ä»»åŠ¡åç§°</th>
                        <th class="column-start-time" data-sort-type="date">å¼€å§‹æ—¶é—´</th>
                        <th class="column-end-time" data-sort-type="date">ç»“æŸæ—¶é—´</th>
                        <th data-sort-type="number">è€—æ—¶</th>
                        <th class="column-revive" data-sort-type="number">å¤æ´»æ¬¡æ•°</th>
                        <th class="column-retry" data-sort-type="number">é‡è¯•æ¬¡æ•°</th>
                        <th class="column-retry-detail" data-sort-type="number">ç–‘ä¼¼å¡æ­»</th>
                        <th class="column-too-far-skip" data-sort-type="number">è¿‡è¿œè·³è¿‡</th>
                        <th class="column-timeout" data-sort-type="number">æˆ˜æ–—è¶…æ—¶</th>
                        <th class="column-teleport" data-sort-type="number">ä¼ é€å¤±è´¥</th>
                    </tr>
                    </thead>
                    <tbody>`;

                group.tasks.forEach((task, taskIndex) => {
                    const hasCoords = task.faults.coords && task.faults.coords.length > 0;

                    // ç”Ÿæˆå¤æ´»äº‹ä»¶å¼¹çª—
                    let revivePopupHTML = '';
                    let hasReviveEvents = false;
                    if (task.reviveEvents && task.reviveEvents.length > 0) {
                        hasReviveEvents = true;
                        revivePopupHTML = '<div class="battle-popup">';
                        revivePopupHTML += '<div class="battle-popup-header">';
                        revivePopupHTML += '<div class="battle-popup-title">å¤æ´»äº‹ä»¶è¯¦ç»†</div>';
                        revivePopupHTML += '<span class="close-btn">Ã—</span>';
                        revivePopupHTML += '</div>';
                        revivePopupHTML += '<div class="battle-popup-content">';

                        // æŒ‰battleCountåˆ†ç»„
                        const eventsByBattleCount = {};
                        task.reviveEvents.forEach(event => {
                            if (!eventsByBattleCount[event.battleCount]) {
                                eventsByBattleCount[event.battleCount] = [];
                            }
                            eventsByBattleCount[event.battleCount].push(event);
                        });

                        // å¤„ç†æˆ˜æ–—å‰çš„å¤æ´»äº‹ä»¶ï¼ˆbattleCountä¸º0ï¼‰
                        if (eventsByBattleCount[0] && eventsByBattleCount[0].length > 0) {
                            eventsByBattleCount[0].forEach(event => {
                                const coordText = event.coord ? `(X=${event.coord.x}, Y=${event.coord.y})` : '';
                                revivePopupHTML += `<div class="battle-item">${coordText}</div>`;
                            });
                        }

                        // ç”Ÿæˆå®Œæ•´çš„æˆ˜æ–—åºåˆ—ï¼ˆä»1åˆ°æœ€å¤§æˆ˜æ–—æ¬¡æ•°ï¼‰
                        for (let i = 1; i <= task.maxBattleCount; i++) {
                            const events = eventsByBattleCount[i] || [];

                            if (events.length > 0) {
                                // æœ‰å¤æ´»äº‹ä»¶ï¼Œæ˜¾ç¤ºåæ ‡
                                const coords = events.map(e => e.coord ? `(X=${e.coord.x}, Y=${e.coord.y})` : '').filter(text => text);
                                const coordText = coords.length > 0 ? 'ï¼š' + coords.join('ã€') : '';
                                revivePopupHTML += `<div class="battle-item">${i}${coordText}</div>`;
                            } else {
                                // æ— å¤æ´»äº‹ä»¶ï¼Œåªæ˜¾ç¤ºåºå·
                                revivePopupHTML += `<div class="battle-item">${i}</div>`;
                            }
                        }

                        revivePopupHTML += '</div></div>';
                    }

                    // ç”Ÿæˆåæ ‡å¼¹çª—HTML
                    let coordPopupHTML = '';
                    if (hasCoords) {
                        coordPopupHTML = '<div class="coord-popup">';
                        coordPopupHTML += '<div class="coord-popup-header">';
                        coordPopupHTML += '<div class="coord-popup-title">å¡æ­»ç‚¹åæ ‡</div>';
                        coordPopupHTML += '<span class="close-btn">Ã—</span>';
                        coordPopupHTML += '</div>';
                        coordPopupHTML += '<div class="coord-popup-content">';

                        task.faults.coords.forEach((coord, idx) => {
                            coordPopupHTML += `<div class="coord-item">`;
                            coordPopupHTML += `<strong>#${idx + 1}</strong><br>`;
                            coordPopupHTML += `X: ${coord.x}<br>Y: ${coord.y}`;
                            coordPopupHTML += '</div>';
                        });

                        coordPopupHTML += '</div></div>';
                    }

                    // ç”Ÿæˆè¶…æ—¶äº‹ä»¶å¼¹çª—
                    let timeoutPopupHTML = '';
                    let hasTimeoutEvents = false;
                    if (task.timeoutEvents && task.timeoutEvents.length > 0) {
                        hasTimeoutEvents = true;
                        timeoutPopupHTML = '<div class="battle-popup">';
                        timeoutPopupHTML += '<div class="battle-popup-header">';
                        timeoutPopupHTML += '<div class="battle-popup-title">è¶…æ—¶äº‹ä»¶è¯¦ç»†</div>';
                        timeoutPopupHTML += '<span class="close-btn">Ã—</span>';
                        timeoutPopupHTML += '</div>';
                        timeoutPopupHTML += '<div class="battle-popup-content">';

                        // ç”Ÿæˆå®Œæ•´çš„æˆ˜æ–—åºåˆ—ï¼ˆä»1åˆ°æœ€å¤§æˆ˜æ–—æ¬¡æ•°ï¼‰
                        for (let i = 1; i <= task.maxBattleCount; i++) {
                            const hasEvent = task.timeoutEvents.includes(i);
                            timeoutPopupHTML += `<div class="battle-item">${i}${hasEvent ? '(X)' : ''}</div>`;
                        }

                        timeoutPopupHTML += '</div></div>';
                    }

                    // è®¾ç½®å•å…ƒæ ¼ç±» - åªåœ¨æœ‰äº‹ä»¶æ—¶æ·»åŠ å¯ç‚¹å‡»ç±»
                    const reviveCellClass = hasReviveEvents ? 'has-battle-events' : 'no-events';
                    const timeoutCellClass = hasTimeoutEvents ? 'has-battle-events' : 'no-events';
                    const cellClass = hasCoords ? 'coords-cell has-coords' : 'coords-cell';

                    // åˆ¤æ–­æ˜¯å¦éœ€è¦å°†ä»»åŠ¡åå’Œè€—æ—¶æ ‡çº¢
                    const shouldHighlight =
                        task.faults.retry > 0 &&
                        task.faults.retryDetail === 0 &&
                        task.faults.revive === 0;

                    // æ ¼å¼åŒ–reviveå€¼ï¼šæ•´æ•°æ˜¾ç¤ºæ•´æ•°ï¼Œå°æ•°æ˜¾ç¤ºä¸¤ä½å°æ•°
                    let reviveDisplay = '';
                    if (task.faults.revive !== 0) {
                        if (Number.isInteger(task.faults.revive)) {
                            reviveDisplay = task.faults.revive;
                        } else {
                            // ç¡®ä¿å°æ•°éƒ¨åˆ†æœ‰ä¸¤ä½
                            reviveDisplay = task.faults.revive.toFixed(2);
                        }
                    }

                    // è®¡ç®—ä»»åŠ¡è€—æ—¶
                    const duration = calculateDuration(task.startTime, task.endTime);

                    // ç”Ÿæˆæ‹¾å–ç‰©æ˜¾ç¤ºæ–‡æœ¬
                    let picksText = formatPicks(task.picks);

                    // æŒ‰é¡ºåºæ·»åŠ æç¤ºæ–‡æœ¬
                    const alerts = [];

                    // 1. å¿«æ·é”®æš‚åœ
                    if (task.hasPause) {
                        alerts.push('<span class="pause-alert">å¿«æ·é”®æš‚åœ</span>');
                    }

                    // 2. é¢†å–æ´¾é£ä»»åŠ¡
                    if (task.hasDispatch) {
                        alerts.push('<span class="dispatch-alert">é¢†å–æ´¾é£ä»»åŠ¡</span>');
                    }

                    // 3. è„šæœ¬æœªæ­£å¸¸èµ°å®Œ
                    if (task.abnormalEnd) {
                        alerts.push('<span class="abnormal-alert">è¿½è¸ªè„šæœ¬æœªæ­£å¸¸èµ°å®Œï¼</span>');
                    }

                    // å¦‚æœæœ‰æç¤ºï¼Œæ·»åŠ åˆ°æ‹¾å–ç‰©æ–‡æœ¬
                    if (alerts.length > 0) {
                        if (picksText === 'æ— ') {
                            picksText = alerts.join('<br>');
                        } else {
                            picksText += '<br>' + alerts.join('<br>');
                        }
                    }

                    html += `
                <tr data-task-id="group-${index}-task-${taskIndex}">
                    <td class="main-row-name ${shouldHighlight ? 'task-name-red' : ''}" rowspan="2">${task.name}</td>
                    <td class="column-start-time">${formatDateTime(task.startTime)}</td>
                    <td class="column-end-time">${task.endTime ? formatDateTime(task.endTime) : 'è¿›è¡Œä¸­'}</td>
                    <td class="${shouldHighlight ? 'duration-red' : ''}">${duration}</td>
                    <td class="column-revive ${reviveCellClass} ${task.faults.revive >= 2 ? 'red' : ''}">
                        ${reviveDisplay}
                        ${revivePopupHTML}
                    </td>
                    <td class="column-retry ${task.faults.retry >= 2 ? 'red' : ''}">${task.faults.retry == 0 ? '' : task.faults.retry}</td>
                    <td class="column-retry-detail ${cellClass} ${task.faults.retryDetail >= 2 ? '' : ''}">
                        ${task.faults.retryDetail == 0 ? '' : task.faults.retryDetail}
                        ${coordPopupHTML}
                    </td>
                    <td class="column-too-far-skip ${task.faults.too_far_skip >= 2 ? 'red' : 'red'}">${task.faults.too_far_skip == 0 ? '' : task.faults.too_far_skip}</td>
                    <td class="column-timeout ${timeoutCellClass} ${task.faults.timeout >= 1 ? 'red' : ''}">
                        ${task.faults.timeout == 0 ? '' : task.faults.timeout}
                        ${timeoutPopupHTML}
                    </td>
                    <td class="column-teleport ${task.faults.teleport >= 3 ? 'red' : ''}">${task.faults.teleport == 0 ? '' : task.faults.teleport}</td>
                </tr>
                <tr class="sub-row" data-task-id="group-${index}-task-${taskIndex}">
                    <td colspan="9" class="column-picks"><span class="picks-bold">æ‹¾å–ç‰©: </span>${picksText}</td>
                </tr>`;
                });

                html += `
                <tr class="ignore-sort">
                    <td colspan="10" class="column-picks"><span class="picks-bold">æ‰€æœ‰æ‹¾å–ç‰©: </span>${formatPicks(group.picks)}</td>
                </tr>
                </tbody></table>
                </div>
                </div>
                </div>`;
            });

            html += '</div>';
            return html;
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(date) {
            if (!date) return 'æœªçŸ¥æ—¶é—´';
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // æ–°å¢æŠ˜å åŠŸèƒ½äº‹ä»¶å¤„ç†
        function setupCollapse() {
            document.querySelectorAll('.group-header').forEach(header => {
                header.addEventListener('click', function () {
                    const groupIndex = this.dataset.groupIndex;
                    const content = document.getElementById(`group-${groupIndex}`);
                    const arrow = this.querySelector('.arrow');

                    content.classList.toggle('collapsed');
                    arrow.classList.toggle('collapsed');
                });
            });
        }

        // æ ¼å¼åŒ–æ‹¾å–ç‰©
        function formatPicks(picks) {
            if (picks.size === 0) return 'æ— ';
            return Array.from(picks.entries())
                .sort((a, b) => b[1] - a[1]) // æŒ‰æ•°é‡ä»å¤šåˆ°å°‘æ’åº
                .map(([item, count]) => `${item} (${count})`)
                .join(', ');
        }

        // æ–°å¢ï¼šæ›´æ–°æ—¶é—´åˆ—çš„æ˜¾ç¤ºçŠ¶æ€
        function updateTimeColumnsVisibility() {
            if (timeColumnsVisible) {
                document.body.classList.remove('time-columns-hidden');
            } else {
                document.body.classList.add('time-columns-hidden');
            }
        }

        // æ–°å¢ï¼šæ˜¾ç¤ºæ—¶é—´åˆ—çŠ¶æ€æç¤º
        function showTimeToggleIndicator() {
            const indicator = document.getElementById('timeToggleIndicator');
            indicator.textContent = `æ—¶é—´åˆ—: ${timeColumnsVisible ? 'æ˜¾ç¤º' : 'éšè—'}`;
            indicator.classList.add('visible');

            // 2ç§’åéšè—æç¤º
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }

        // æ–°å¢ï¼šæ›´æ–°ç»Ÿè®¡åˆ—çš„æ˜¾ç¤ºçŠ¶æ€
        function updateStatsColumnsVisibility() {
            if (statsColumnsVisible) {
                document.body.classList.remove('stats-columns-hidden');
            } else {
                document.body.classList.add('stats-columns-hidden');
            }
        }

        // æ–°å¢ï¼šæ˜¾ç¤ºç»Ÿè®¡åˆ—çŠ¶æ€æç¤º
        function showStatsToggleIndicator() {
            const indicator = document.getElementById('statsToggleIndicator');
            indicator.textContent = `ç»Ÿè®¡åˆ—: ${statsColumnsVisible ? 'æ˜¾ç¤º' : 'éšè—'}`;
            indicator.classList.add('visible');

            // 2ç§’åéšè—æç¤º
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }

        // æ·»åŠ æ‹¾å–ç‰©åˆ—æ˜¾ç¤ºçŠ¶æ€æ›´æ–°å‡½æ•°
        function updatePicksColumnsVisibility() {
            if (picksColumnsVisible) {
                document.body.classList.remove('picks-columns-hidden');
            } else {
                document.body.classList.add('picks-columns-hidden');
            }
        }

        // æ·»åŠ æ‹¾å–ç‰©åˆ—çŠ¶æ€æç¤ºå‡½æ•°
        function showPicksToggleIndicator() {
            const indicator = document.getElementById('picksToggleIndicator');
            indicator.textContent = `æ‹¾å–ç‰©åˆ—: ${picksColumnsVisible ? 'æ˜¾ç¤º' : 'éšè—'}`;
            indicator.classList.add('visible');

            // 2ç§’åéšè—æç¤º
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }

        // æ–°å¢ï¼šæ›´æ–°è¡¨æ ¼æ ¼å¼
        function updateTableFormat() {
            if (useLegacyFormat) {
                document.body.classList.add('legacy-format');
            } else {
                document.body.classList.remove('legacy-format');
            }
        }

        // æ–°å¢ï¼šæ˜¾ç¤ºè¡¨æ ¼æ ¼å¼çŠ¶æ€æç¤º
        function showFormatToggleIndicator() {
            const indicator = document.getElementById('formatToggleIndicator');
            indicator.textContent = `è¡¨æ ¼æ ¼å¼: ${useLegacyFormat ? 'æ–°ç‰ˆ' : 'æ—§ç‰ˆ'}`;
            indicator.classList.add('visible');

            // 2ç§’åéšè—æç¤º
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }

        // æ–°å¢ï¼šé‡æ–°ç”ŸæˆHTML
        function refreshHTML() {
            const result = parsingContext.allGroups;
            dropZone.innerHTML = generateHTML(result);
            setupCoordPopups();
            document.querySelectorAll('.group-header').forEach((el, i) => {
                el.onclick = () => {
                    el.classList.toggle('collapsed');
                    document.getElementById(`group-${i}`).classList.toggle('collapsed');
                };
            });

            // åº”ç”¨å½“å‰æ˜¾ç¤ºçŠ¶æ€
            updateTimeColumnsVisibility();
            updateStatsColumnsVisibility();
            updatePicksColumnsVisibility(); // æ–°å¢ï¼šåº”ç”¨æ‹¾å–ç‰©åˆ—æ˜¾ç¤ºçŠ¶æ€
            updateTableFormat();

            // è®¾ç½®è¡Œé«˜äº®æ•ˆæœ
            setupRowHighlight();

            // åº”ç”¨é›¶ç»Ÿè®¡ä»»åŠ¡æ˜¾ç¤ºçŠ¶æ€
            toggleZeroStatsTasks();
        }

        // æ–°å¢ï¼šè®¾ç½®è¡Œé«˜äº®æ•ˆæœ
        function setupRowHighlight() {
            const tables = document.querySelectorAll('table');

            tables.forEach(table => {
                // æ—§ç‰ˆè¡¨æ ¼ï¼šå•è¡Œé«˜äº®
                if (!useLegacyFormat) {
                    const rows = table.querySelectorAll('tr:not(.sticky-header)');
                    rows.forEach(row => {
                        row.addEventListener('mouseenter', () => {
                            row.classList.add('highlighted');
                        });

                        row.addEventListener('mouseleave', () => {
                            row.classList.remove('highlighted');
                        });
                    });
                }
                // æ–°ç‰ˆè¡¨æ ¼ï¼šå…³è”è¡Œé«˜äº®
                else {
                    // ä¸ºæ‰€æœ‰è¡Œæ·»åŠ äº‹ä»¶ç›‘å¬
                    const rows = table.querySelectorAll('tr');
                    rows.forEach(row => {
                        row.addEventListener('mouseenter', () => {
                            const taskId = row.getAttribute('data-task-id');
                            if (taskId) {
                                const relatedRows = table.querySelectorAll(`tr[data-task-id="${taskId}"]`);
                                relatedRows.forEach(r => r.classList.add('highlighted'));
                            }
                        });

                        row.addEventListener('mouseleave', () => {
                            const taskId = row.getAttribute('data-task-id');
                            if (taskId) {
                                const relatedRows = table.querySelectorAll(`tr[data-task-id="${taskId}"]`);
                                relatedRows.forEach(r => r.classList.remove('highlighted'));
                            }
                        });
                    });
                }
            });
        }

        // ç›£è½éµç›¤æŒ‰ä¸‹
        document.onkeydown = function (e) {
            var keyNum = e;       // // ä½¿ç”¨äº‹ä»¶å¯¹è±¡è€Œä¸æ˜¯ window.event

            if (keyNum.keyCode == 55) {
                // 7 è¨ˆç®—åŸç¥ä¸‹æ¬¡40é«”æ™‚é–“
                // å‘¼å«è¦–çª—ã€è¦æ±‚ç¾åœ¨é«”åŠ›
                var ps = prompt("è¼¸å…¥ç¾åœ¨_åŸç¥_é«”åŠ›", "");
                ps = ps.split(",")

                // åˆ¤å®šæ˜¯å¦æ•¸å­—
                if (isFinite(ps[0])) {
                    // æ˜¯å¦æœ‰åƒæ•¸æ¬¡æ•¸                        
                    if (isFinite(ps[1])) {
                        var endText = "ä¸‹æ¬¡_åŸç¥_40é«”åŠ›_æ™‚é–“å¤§ç´„ç‚º"
                        for (var i = 0; i < Number(ps[1]); i++) {
                            endText = endText + "___" + GCSRT(Number(ps[0]), 40 * (i + 1), 8);
                        }
                        // è¼ªå‡ºçµæœ
                        alert(endText);
                    } else {
                        alert("ä¸‹æ¬¡_åŸç¥_40é«”åŠ›_æ™‚é–“å¤§ç´„ç‚º___" + GCSRT(Number(ps), 40, 8) + "___" + GCSRT(Number(ps), 80, 8) + "ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚" + GCSRT(Number(ps), 200, 8));
                    }
                } else {
                    alert("è«‹è¼¸å…¥æ•¸å­—");
                }
            } else if (keyNum.keyCode == 57) {
                // 9 è¨ˆç®—ä»»å‹™è·é›¢æ™‚é–“
                handleDateComparison();
            } else if (keyNum.keyCode == 96 || keyNum.keyCode == 48) {
                // å·¦0orå³0 å¹«åŠ©
                var help_text = "";
                help_text += "Better Genshin Impact æ—¥å¿—åˆ†æå·¥å…· - ç®€æ˜“è¯´æ˜\n";
                help_text += "â€¢ é¼ æ ‡æ‚¬åœç»Ÿè®¡æ•°å­—æŸ¥çœ‹è¯¦æƒ…\n\n";

                help_text += "å¸¸ç”¨å¿«æ·é”®:\n";
                help_text += "T   åˆ‡æ¢æ—¶é—´åˆ—æ˜¾ç¤º/éšè—\n";
                help_text += "Y   åˆ‡æ¢ç»Ÿè®¡åˆ—æ˜¾ç¤º/éšè—\n";
                help_text += "U   åˆ‡æ¢è¡¨æ ¼æ ¼å¼(æ–°æ—§ç‰ˆ)\n";
                help_text += "I   åˆ‡æ¢æ‹¾å–ç‰©åˆ—æ˜¾ç¤º/éšè—\n";
                help_text += "J   éšè—/æ˜¾ç¤ºæ‰€æœ‰ç»Ÿè®¡ä¸º0çš„ä»»åŠ¡\n";
                help_text += "P   è¿›å…¥/é€€å‡ºå¯¼å‡ºæ¨¡å¼\n";
                help_text += "~   åˆ‡æ¢äº®è‰²/æš—è‰²ä¸»é¢˜\n";
                help_text += "R   é‡ç½®å¼¹çª—ä½ç½®\n\n";

                help_text += "å®ç”¨è®¡ç®—åŠŸèƒ½:\n";
                help_text += "7   è®¡ç®—åŸç¥ä¸‹æ¬¡40ä½“åŠ›æ—¶é—´\n";
                help_text += "9   è®¡ç®—æ—¶é—´è·ç¦»ç°åœ¨å¤šä¹…\n";
                help_text += "å³2 è®¡ç®—æ—¥æœŸ+3å¤©\n";
                help_text += "å³3 è®¡ç®—ä¸¤ä¸ªæ—¶é—´ç‚¹é—´éš”\n";
                help_text += "å³5 è®¡ç®—Nå¤©åçš„æ—¥æœŸ\n";
                help_text += "å³7 è®¡ç®—åŸç¥ä¸‹æ¬¡120ä½“åŠ›æ—¶é—´\n";
                help_text += "å³8 è®¡ç®—HH.MMåçš„æ—¶é—´\n";
                help_text += "å³9 è®¡ç®—æ—¶é—´+46å°æ—¶å\n\n";
                help_text += "è¯¦ç»†è¯´æ˜è¯·å¤åˆ¶ä¸‹æ–¹ç½‘å€æŸ¥çœ‹:";

                // ä½¿ç”¨promptå¹¶é¢„è®¾ç½‘å€ï¼Œæ–¹ä¾¿ç”¨æˆ·å¤åˆ¶
                prompt(help_text, "https://github.com/this-Fish/this-fish.github.io/tree/main/Read_BetterGI_Log");

            } else if (keyNum.keyCode == 98) {
                // è¨ˆç®—BGIæ—¥å¿—æ ¼å¼ +3å¤©
                addThreeDaysSimple();
            } else if (keyNum.keyCode == 99) {
                // å³3 è¨ˆç®—é‹è¡Œæ™‚é–“
                calculateTimeDifference();
            } else if (keyNum.keyCode == 101) {
                // å³5 è¨ˆç®—+Nå¤©æ•¸
                handleAddDays();
            } else if (keyNum.keyCode == 103) {
                // å³7 è¨ˆç®—åŸç¥ä¸‹æ¬¡120é«”æ™‚é–“
                // å‘¼å«è¦–çª—ã€è¦æ±‚ç¾åœ¨é«”åŠ›
                var ps = prompt("è¼¸å…¥ç¾åœ¨_åŸç¥_é«”åŠ›", "");
                ps = ps.split(",")

                // åˆ¤å®šæ˜¯å¦æ•¸å­—
                if (isFinite(ps[0])) {
                    // æ˜¯å¦æœ‰åƒæ•¸æ¬¡æ•¸                        
                    if (isFinite(ps[1])) {
                        var endText = "ä¸‹æ¬¡_åŸç¥_120é«”åŠ›_æ™‚é–“å¤§ç´„ç‚º"
                        for (var i = 0; i < Number(ps[1]); i++) {
                            endText = endText + "___" + GCSRT(Number(ps[0]), 120 * (i + 1), 8);
                        }
                        // è¼ªå‡ºçµæœ
                        alert(endText);
                    } else {
                        alert("ä¸‹æ¬¡_åŸç¥_120é«”åŠ›_æ™‚é–“å¤§ç´„ç‚º___" + GCSRT(Number(ps), 120, 8) + "ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚" + GCSRT(Number(ps), 200, 8));
                    }
                } else {
                    alert("è«‹è¼¸å…¥æ•¸å­—");
                }
            } else if (keyNum.keyCode == 104) {
                // å³8 è¨ˆç®—ä»»å‹™HH.MMåæ™‚é–“
                handleAddCustomTime();
            } else if (keyNum.keyCode == 105) {
                // å³9 è¨ˆç®—ä»»å‹™46å°æ™‚åæ™‚é–“
                handleDateAddition();
            } else if (keyNum.keyCode == 70 && keyNum.altKey) {
                // alt +  f
                toggleFullScreen();
                e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
                return;
            } else if (keyNum.keyCode == 192) {
                document.body.classList.toggle('dark-theme'); // åˆ‡æ¢æš—è‰²ä¸»é¢˜

                // æ›´æ–°å¸®åŠ©æç¤ºçš„æ ·å¼
                const helpIndicator = document.getElementById('helpIndicator');
                if (document.body.classList.contains('dark-theme')) {
                    helpIndicator.style.backgroundColor = '#fff';
                    helpIndicator.style.color = '#000';
                } else {
                    helpIndicator.style.backgroundColor = '#000';
                    helpIndicator.style.color = '#fff';
                }
            } else if (keyNum.keyCode == 87) {
                // W ç•«é¢å‘ä¸Šç§»
                dropZone.scrollBy(0, -150);
            } else if (keyNum.keyCode == 83) {
                // S ç•«é¢å‘ä¸‹ç§»
                dropZone.scrollBy(0, 150);
            } else if (keyNum.keyCode == 110 || keyNum.keyCode == 190) {
                // å·¦. å³. åŒè¦–çª—é–‹æ–°é é¢
                window.open("index.html");
            } else if (keyNum.keyCode === 82) {
                // Ré”®
                if (window.resetCoordPopups) {
                    window.resetCoordPopups();
                }
                e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
            } else if (keyNum.keyCode == 84) { // Té”® - åˆ‡æ¢æ—¶é—´åˆ—æ˜¾ç¤º
                timeColumnsVisible = !timeColumnsVisible;
                updateTimeColumnsVisibility();
                showTimeToggleIndicator();
                e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
            } else if (keyNum.keyCode == 89) { // Yé”® - åˆ‡æ¢ç»Ÿè®¡åˆ—æ˜¾ç¤º
                statsColumnsVisible = !statsColumnsVisible;
                updateStatsColumnsVisibility();
                showStatsToggleIndicator();
                e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
            } else if (keyNum.keyCode == 85) { // Ué”® - åˆ‡æ¢è¡¨æ ¼æ ¼å¼
                // æ£€æŸ¥æ˜¯å¦æœ‰æ—¥å¿—æ•°æ®
                if (!hasLogData) {
                    e.preventDefault();
                    return;
                }

                // åˆ‡æ¢æ ¼å¼å‰é‡ç½®æ‰€æœ‰åˆ—ä¸ºæ˜¾ç¤ºçŠ¶æ€
                // timeColumnsVisible = true;
                // statsColumnsVisible = true;
                // picksColumnsVisible = true;

                useLegacyFormat = !useLegacyFormat;
                refreshHTML();
                showFormatToggleIndicator();
                e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
            } else if (keyNum.keyCode == 73) { // Ié”® - åˆ‡æ¢æ‹¾å–ç‰©åˆ—æ˜¾ç¤ºï¼ˆä»…æ—§ç‰ˆæ ¼å¼ï¼‰
                // if (!useLegacyFormat) {
                picksColumnsVisible = !picksColumnsVisible;
                updatePicksColumnsVisibility();
                showPicksToggleIndicator();
                e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
                // }
            } else if (keyNum.keyCode == 74) { // Jé”® - éšè—/æ˜¾ç¤ºæ‰€æœ‰ç»Ÿè®¡ä¸º0çš„ä»»åŠ¡
                hideZeroStatsTasks = !hideZeroStatsTasks;
                toggleZeroStatsTasks();
                showZeroStatsToggleIndicator();
                e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
            } else if (keyNum.keyCode === 80 || keyNum.key === 'p' || keyNum.key === 'P') {
                // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œé¿å…å¯èƒ½å†²çª
                e.preventDefault();

                // å¤„ç†Pé”®åŠŸèƒ½
                handlePKey();
            }
        }

        // æ·»åŠ æ˜¾ç¤ºçŠ¶æ€æç¤ºå‡½æ•°
        function showZeroStatsToggleIndicator() {
            const indicator = document.getElementById('zeroStatsToggleIndicator');
            indicator.textContent = `é›¶ç»Ÿè®¡ä»»åŠ¡: ${hideZeroStatsTasks ? 'éšè—' : 'æ˜¾ç¤º'}`;
            indicator.classList.add('visible');

            // 2ç§’åéšè—æç¤º
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }

        // æ·»åŠ åˆ‡æ¢é›¶ç»Ÿè®¡ä»»åŠ¡æ˜¾ç¤ºçŠ¶æ€çš„å‡½æ•°
        function toggleZeroStatsTasks() {
            const tables = document.querySelectorAll('table');

            tables.forEach(table => {
                const rows = table.querySelectorAll('tr');

                rows.forEach(row => {
                    // è·³è¿‡è¡¨å¤´è¡Œ
                    if (row.querySelector('th')) return;

                    // è·å–ç»Ÿè®¡å•å…ƒæ ¼
                    const reviveCell = row.querySelector('.column-revive');
                    const retryCell = row.querySelector('.column-retry');
                    const retryDetailCell = row.querySelector('.column-retry-detail');
                    const tooFarSkipCell = row.querySelector('.column-too-far-skip');
                    const timeoutCell = row.querySelector('.column-timeout');
                    const teleportCell = row.querySelector('.column-teleport');

                    if (reviveCell && retryCell && retryDetailCell && tooFarSkipCell && timeoutCell && teleportCell) {
                        // æ£€æŸ¥æ‰€æœ‰ç»Ÿè®¡å€¼æ˜¯å¦éƒ½ä¸º0æˆ–ç©º
                        const isAllZero =
                            (reviveCell.textContent.trim() === '' || reviveCell.textContent.trim() === '0') &&
                            (retryCell.textContent.trim() === '' || retryCell.textContent.trim() === '0') &&
                            (retryDetailCell.textContent.trim() === '' || retryDetailCell.textContent.trim() === '0') &&
                            (tooFarSkipCell.textContent.trim() === '' || tooFarSkipCell.textContent.trim() === '0') &&
                            (timeoutCell.textContent.trim() === '' || timeoutCell.textContent.trim() === '0') &&
                            (teleportCell.textContent.trim() === '' || teleportCell.textContent.trim() === '0');

                        // æ ¹æ®è®¾ç½®æ˜¾ç¤ºæˆ–éšè—è¡Œ
                        if (isAllZero) {
                            row.style.display = hideZeroStatsTasks ? 'none' : '';

                            // å¯¹äºæ—§ç‰ˆæ ¼å¼ï¼Œè¿˜éœ€è¦å¤„ç†å…³è”çš„æ‹¾å–ç‰©è¡Œ
                            if (useLegacyFormat) {
                                const taskId = row.getAttribute('data-task-id');
                                if (taskId) {
                                    const relatedRows = table.querySelectorAll(`tr[data-task-id="${taskId}"]`);
                                    relatedRows.forEach(r => {
                                        r.style.display = hideZeroStatsTasks ? 'none' : '';
                                    });
                                }
                            }
                        }
                    }
                });
            });
        }

        /**
         * è¨ˆç®—é«”åŠ›æ¢å¾©å®Œæˆçš„æ™‚é–“
         * calculateStaminaRecoveryTime
         * GCSRT(ç¾åœ¨é«”åŠ›,åŸ40orå°˜30,åŸ8orå°˜6)
         * @param {number} currentStamina ç•¶å‰é«”åŠ›å€¼
         * @param {number} targetStamina éœ€è¦é”åˆ°çš„ç›®æ¨™é«”åŠ›å€¼
         * @param {number} minutesPerPoint æ¯æ¢å¾©1é»é«”åŠ›éœ€è¦çš„åˆ†é˜æ•¸
         * @returns {object} åŒ…å«æ¢å¾©å®Œæˆçš„æ™‚é–“ï¼ˆDate å°è±¡ï¼‰å’Œæ ¼å¼åŒ–æ™‚é–“å­—ç¬¦ä¸²çš„å°è±¡
         */
        function GCSRT(currentStamina, targetStamina, minutesPerPoint) {
            // åƒæ•¸æ ¡é©—
            if (typeof currentStamina !== 'number' ||
                typeof targetStamina !== 'number' ||
                typeof minutesPerPoint !== 'number') {
                throw new Error('æ‰€æœ‰åƒæ•¸å¿…é ˆæ˜¯æ•¸å­—é¡å‹');
            }

            // å¦‚ç¾æ™‚é«”åŠ›è¶…éç›®æ¨™ï¼Œæ¸›éç¾æ™‚é«”åŠ›ã€è¨ˆç®—ä¸‹æ¬¡ç›®æ¨™é«”åŠ›
            if (currentStamina >= targetStamina) {
                currentStamina = currentStamina - targetStamina;
                targetStamina = targetStamina + targetStamina;
            }

            // è¨ˆç®—é«”åŠ›å·®
            const staminaDifference = targetStamina - currentStamina;

            // è¨ˆç®—ç¸½éœ€è¦åˆ†é˜æ•¸
            const totalMinutes = staminaDifference * minutesPerPoint;

            // è¨ˆç®—æ¢å¾©å®Œæˆçš„æ™‚é–“
            const now = new Date(); // ç•¶å‰æ™‚é–“
            const recoveryTime = new Date(now.getTime() + totalMinutes * 60000); // åŠ ä¸Šç¸½åˆ†é˜æ•¸

            // æ ¼å¼åŒ–æ™‚é–“è¼¸å‡º
            const formattedTime = recoveryTime.toLocaleString(); // æ ¹æ“šæœ¬åœ°æ™‚é–“æ ¼å¼é¡¯ç¤º

            return ` ${recoveryTime.getHours()} : ${recoveryTime.getMinutes()}`;
        }

        // è¨ˆç®—æ™‚é–“å·®
        function handleDateComparison() {
            // è·å–ç”¨æˆ·è¾“å…¥
            const input = prompt("è«‹è¼¸å…¥æ—¥æœŸæ™‚é–“ï¼ˆæ ¼å¼ï¼šYYYY/MM/DD HH:mm:ssï¼‰");

            // éªŒè¯è¾“å…¥æ˜¯å¦ä¸ºç©º
            if (input === null || input.trim() === "") {
                // alert("è¼¸å…¥å·²å–æ¶ˆæˆ–ç‚ºç©ºï¼");
                console.log("è¼¸å…¥å·²å–æ¶ˆæˆ–ç‚ºç©ºï¼");
                return;
            }

            // éªŒè¯æ ¼å¼æ­£åˆ™è¡¨è¾¾å¼
            const formatRegex = /^\d{4}[-\/]\d{2}[-\/]\d{2} \d{2}:\d{2}:\d{2}$/;
            if (!formatRegex.test(input)) {
                alert("æ ¼å¼éŒ¯èª¤ï¼è«‹åš´æ ¼æŒ‰ç…§ç¤ºä¾‹æ ¼å¼è¼¸å…¥");
                return;
            }

            // è§£ææ—¥æœŸ
            const parseDate = (str) => {
                const [datePart, timePart] = str.split(" ");
                const [year, month, day] = datePart.split(/[-\/]/).map(Number); // ä½¿ç”¨æ­£å‰‡åˆ†å‰²ç¬¦
                const [hours, minutes, seconds] = timePart.split(":").map(Number);
                return new Date(year, month - 1, day, hours, minutes, seconds);
            };

            try {
                const targetDate = parseDate(input);
                const now = new Date();

                // æ£€æŸ¥æ—¥æœŸæœ‰æ•ˆæ€§
                if (isNaN(targetDate.getTime())) {
                    throw new Error("ç„¡æ•ˆçš„æ—¥æœŸæ™‚é–“");
                }

                // è®¡ç®—æ—¶é—´å·®ï¼ˆæ¯«ç§’ï¼‰
                const diff = targetDate - now;

                // æ ¼å¼åŒ–æ—¶é—´å·®
                const formatDuration = (ms) => {
                    const seconds = Math.floor(Math.abs(ms) / 1000);
                    const days = Math.floor(seconds / 86400);
                    const hours = Math.floor((seconds % 86400) / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const sec = seconds % 60;
                    return `${days}å¤© ${hours}å°æ™‚ ${minutes}åˆ†é˜ ${sec}ç§’`;
                };

                if (diff < 0) {
                    alert(`è·é›¢ ${input} å·²ç¶“éå»äº†ï¼š\n${formatDuration(diff)}`);
                } else {
                    alert(`è·é›¢ ${input} é‚„æœ‰ï¼š\n${formatDuration(diff)}`);
                }
            } catch (e) {
                alert(`éŒ¯èª¤ï¼š${e.message}`);
            }
        }

        // BGIæ ¼å¼æ—¥æœŸ+3å¤©
        function addThreeDaysSimple() {
            // è·å–ç”¨æˆ·è¾“å…¥
            const input = prompt("è«‹è¼¸å…¥æ—¥æœŸï¼ˆæ ¼å¼ï¼šæŒ‡å®šæ—¥æœŸæ ¼å¼ï¼‰\nä¾‹å¦‚ï¼š2025/05/22 æˆ– 2025-05-22");

            // éªŒè¯è¾“å…¥æ˜¯å¦ä¸ºç©º
            if (input === null || input.trim() === "") {
                alert("è¼¸å…¥å·²å–æ¶ˆæˆ–ç‚ºç©ºï¼");
                return;
            }

            // æ›´çµæ´»çš„æ ¼å¼æ­£åˆ™è¡¨è¾¾å¼ï¼ˆæ”¯æŒ / å’Œ - åˆ†éš”ç¬¦ï¼‰
            const formatRegex = /^\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2}$/;
            const formatRegex2 = /^\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2}$/;
            if (!formatRegex.test(input) && !formatRegex2.test(input)) {
                alert("æ ¼å¼éŒ¯èª¤ï¼è«‹ä½¿ç”¨ YYYY/MM/DD æˆ– YYYY-MM-DD æ ¼å¼è¼¸å…¥");
                return;
            }

            // è§£ææ—¥æœŸï¼ˆæ”¯æŒ / å’Œ - åˆ†éš”ç¬¦ï¼‰
            const parseDate = (str) => {
                const separator = str.includes('/') ? '/' : '-';
                const parts = str.split(separator);
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // æœˆä»½ä»0å¼€å§‹
                const day = parseInt(parts[2], 10);
                return new Date(year, month, day);
            };

            try {
                const inputDate = parseDate(input);

                // æ£€æŸ¥æ—¥æœŸæœ‰æ•ˆæ€§
                if (isNaN(inputDate.getTime())) {
                    throw new Error("ç„¡æ•ˆçš„æ—¥æœŸ");
                }

                // æ·»åŠ 3å¤©
                const resultDate = new Date(inputDate);
                resultDate.setDate(resultDate.getDate() + 3);

                // æ ¼å¼åŒ–æ—¥æœŸå‡½æ•°ï¼ˆä»…æ˜¾ç¤ºå¹´æœˆæ—¥ï¼‰
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}/${month}/${day}`;
                };

                // æ˜¾ç¤ºç»“æœ
                alert(
                    `åŸå§‹æ—¥æœŸï¼š${formatDate(inputDate)}\n` +
                    `åŠ 3å¤©å¾Œæ—¥æœŸï¼š${formatDate(resultDate)}`
                );

            } catch (e) {
                alert(`éŒ¯èª¤ï¼š${e.message}`);
            }
        }

        // è¨ˆç®—é‹è¡Œæ™‚é–“
        function calculateTimeDifference() {
            // è¼¸å…¥æ ¼å¼é©—è­‰æ­£å‰‡
            const timeFormatRegex = /^\d{4}[-\/]\d{2}[-\/]\d{2} \d{2}:\d{2}:\d{2}$/;

            // ç²å–ç¬¬ä¸€å€‹æ™‚é–“
            const time1Str = prompt("è«‹è¼¸å…¥ç¬¬ä¸€å€‹æ™‚é–“ï¼ˆæ ¼å¼ï¼šYYYY/MM/DD HH:mm:ssï¼‰\nç¯„ä¾‹ï¼š2025/05/22 10:52:05");
            if (!time1Str || !timeFormatRegex.test(time1Str)) {
                alert("è¼¸å…¥å–æ¶ˆæˆ–æ ¼å¼éŒ¯èª¤ï¼");
                return;
            }

            // ç²å–ç¬¬äºŒå€‹æ™‚é–“
            const time2Str = prompt("è«‹è¼¸å…¥ç¬¬äºŒå€‹æ™‚é–“ï¼ˆæ ¼å¼ï¼šYYYY/MM/DD HH:mm:ssï¼‰");
            if (!time2Str || !timeFormatRegex.test(time2Str)) {
                alert("è¼¸å…¥å–æ¶ˆæˆ–æ ¼å¼éŒ¯èª¤ï¼");
                return;
            }

            // è§£ææ™‚é–“å‡½æ•¸
            const parseTime = (str) => {
                const [datePart, timePart] = str.split(' ');
                const [year, month, day] = datePart.split(/[-\/]/).map(Number); // ä½¿ç”¨æ­£å‰‡åˆ†å‰²ç¬¦
                const [hours, minutes, seconds] = timePart.split(':').map(Number);
                return new Date(year, month - 1, day, hours, minutes, seconds);
            };

            try {
                // è§£ææ—¥æœŸå°è±¡
                const date1 = parseTime(time1Str);
                const date2 = parseTime(time2Str);

                // é©—è­‰æ—¥æœŸæœ‰æ•ˆæ€§
                if (isNaN(date1.getTime()) || isNaN(date2.getTime())) {
                    throw new Error("åŒ…å«ç„¡æ•ˆæ—¥æœŸæ™‚é–“");
                }

                // è¨ˆç®—æ™‚é–“å·®ï¼ˆæ¯«ç§’ï¼‰
                const diffMs = date2 - date1;

                // æ™‚é–“å·®æ ¼å¼åŒ–
                const formatDuration = (ms) => {
                    const absMs = Math.abs(ms);
                    const seconds = Math.floor(absMs / 1000);
                    const days = Math.floor(seconds / 86400);
                    const hours = Math.floor((seconds % 86400) / 3600);
                    const minutes = Math.floor((seconds % 3600) / 60);
                    const secs = seconds % 60;
                    return `${days}å¤© ${hours}å°æ™‚ ${minutes}åˆ†é˜ ${secs}ç§’`;
                };

                // åˆ¤æ–·å…ˆå¾Œé—œä¿‚
                let orderText = '';
                if (diffMs > 0) {
                    orderText = `${time2Str} æ™šæ–¼ ${time1Str}`;
                } else if (diffMs < 0) {
                    orderText = `${time2Str} æ—©æ–¼ ${time1Str}`;
                } else {
                    orderText = "å…©å€‹æ™‚é–“å®Œå…¨ç›¸åŒ";
                }

                // é¡¯ç¤ºçµæœ
                alert(
                    `æ™‚é–“å·®è¨ˆç®—çµæœï¼š\n\n` +
                    `${orderText}\n` +
                    `ç›¸å·®ï¼š${formatDuration(diffMs)}`
                );

            } catch (e) {
                alert(`éŒ¯èª¤ï¼š${e.message}`);
            }
        }

        // è¨ˆç®—+Nå¤©æ•¸
        function handleAddDays() {
            // ç²å–ç”¨æˆ¶è¼¸å…¥
            const input = prompt("è«‹è¼¸å…¥è¦æ·»åŠ çš„å¤©æ•¸");

            // é©—è­‰è¼¸å…¥æ˜¯å¦ç‚ºç©º
            if (input === null || input.trim() === "") {
                alert("è¼¸å…¥å·²å–æ¶ˆæˆ–ç‚ºç©ºï¼");
                return;
            }

            // è½‰æ›ç‚ºæ•¸å­—
            const days = parseFloat(input);
            if (isNaN(days)) {
                alert("ç„¡æ•ˆçš„æ•¸å­—ï¼è«‹è¼¸å…¥æœ‰æ•ˆçš„å¤©æ•¸");
                return;
            }

            // è¨ˆç®—æ–°æ—¥æœŸ
            const currentDate = new Date();
            const newDate = new Date(currentDate.getTime() + days * 86400000);

            // æ ¼å¼åŒ–æ—¥æœŸå‡½æ•¸
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}/${month}/${day}`;
            };

            // é¡¯ç¤ºçµæœ
            alert(
                `ç•¶å‰æ™‚é–“ï¼š${formatDate(currentDate)}\n` +
                `åŠ ä¸Š ${days} å¤©å¾Œçš„æ™‚é–“ï¼š${formatDate(newDate)}`
            );
        }

        // è¨ˆç®—ä»»å‹™HH.MMåæ™‚é–“
        function handleAddCustomTime() {
            // ç²å–ç”¨æˆ¶è¼¸å…¥
            const input = prompt("è«‹è¼¸å…¥è¦æ·»åŠ çš„æ™‚é–“ï¼ˆæ ¼å¼ï¼šhh.mmï¼Œä¾‹å¦‚ 02.30ï¼‰");

            // é©—è­‰è¼¸å…¥æ˜¯å¦ç‚ºç©º
            if (input === null || input.trim() === "") {
                alert("è¼¸å…¥å·²å–æ¶ˆæˆ–ç‚ºç©ºï¼");
                return;
            }

            // é©—è­‰æ ¼å¼æ­£å‰‡è¡¨é”å¼
            const timeFormatRegex = /^-?\d{1,2}\.\d{1,2}$/;
            if (!timeFormatRegex.test(input)) {
                alert("æ ¼å¼éŒ¯èª¤ï¼è«‹ä½¿ç”¨ hh.mm æ ¼å¼è¼¸å…¥ï¼ˆä¾‹å¦‚ 03.15 æˆ– 2.5ï¼‰");
                return;
            }

            // è§£ææ™‚é–“
            const [hoursStr, minutesStr] = input.split('.');
            const hours = parseInt(hoursStr, 10);
            const minutes = parseInt(minutesStr, 10);

            // é©—è­‰æ™‚é–“ç¯„åœ
            if (Math.abs(hours) > 8760) { // é˜²æ­¢éå¤§æ•¸å€¼ï¼ˆç´„1å¹´ï¼‰
                alert("å°æ™‚æ•¸å€¼éå¤§ï¼");
                return;
            }
            if (Math.abs(minutes) > 59) {
                alert("åˆ†é˜æ•¸å€¼éœ€åœ¨ 0-59 ä¹‹é–“");
                return;
            }

            // è¨ˆç®—æ™‚é–“å·®
            const currentDate = new Date();
            const timeToAdd =
                hours * 60 * 60 * 1000 +
                minutes * 60 * 1000;

            // è¨ˆç®—æ–°æ™‚é–“
            const newDate = new Date(currentDate.getTime() + timeToAdd);

            // æ ¼å¼åŒ–æ—¥æœŸå‡½æ•¸ï¼ˆä¸é¡¯ç¤ºç§’æ•¸ï¼‰
            const formatTime = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const mins = String(date.getMinutes()).padStart(2, '0');
                return `${year}/${month}/${day} ${hours}:${mins}`;
            };

            // é¡¯ç¤ºçµæœ
            alert(
                `ç•¶å‰æ™‚é–“ï¼š${formatTime(currentDate)}\n` +
                `åŠ ä¸Š ${input.replace('.', 'å°æ™‚')}åˆ†é˜ å¾Œæ™‚é–“ï¼š${formatTime(newDate)}`
            );
        }

        // è¨ˆç®—46å°æ™‚å
        function handleDateAddition() {
            // ç²å–ç”¨æˆ¶è¼¸å…¥
            const input = prompt("è«‹è¼¸å…¥æ—¥æœŸæ™‚é–“ï¼ˆæ ¼å¼ï¼šYYYY/MM/DD HH:mm:ssï¼‰");

            // é©—è­‰è¼¸å…¥æ˜¯å¦ç‚ºç©º
            if (input === null || input.trim() === "") {
                console.log("è¼¸å…¥å·²å–æ¶ˆæˆ–ç‚ºç©ºï¼");
                return;
            }

            // é©—è­‰æ ¼å¼æ­£å‰‡è¡¨é”å¼
            const formatRegex = /^\d{4}[\/]\d{2}[\/]\d{2} \d{2}:\d{2}:\d{2}$/;  // åš´æ ¼åŒ¹é…æ–œæ 
            if (!formatRegex.test(input)) {
                alert("æ ¼å¼éŒ¯èª¤ï¼è«‹åš´æ ¼æŒ‰ç…§YYYY/MM/DD HH:mm:ssæ ¼å¼è¼¸å…¥");
                return;
            }

            // è§£ææ—¥æœŸ
            const parseDate = (str) => {
                const [datePart, timePart] = str.split(" ");
                const [year, month, day] = datePart.split("/").map(Number);  // å›ºå®šä½¿ç”¨æ–œæ åˆ†å‰²
                const [hours, minutes, seconds] = timePart.split(":").map(Number);
                return new Date(year, month - 1, day, hours, minutes, seconds);
            };

            try {
                const targetDate = parseDate(input);

                // æª¢æŸ¥æ—¥æœŸæœ‰æ•ˆæ€§
                if (isNaN(targetDate.getTime())) {
                    throw new Error("ç„¡æ•ˆçš„æ—¥æœŸæ™‚é–“");
                }

                // åŠ ä¸Š46å°æ™‚
                const newDate = new Date(targetDate.getTime() + 46 * 60 * 60 * 1000);

                // æ ¼å¼åŒ–è¼¸å‡º
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');  // è£œé›¶
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
                };

                alert(
                    `åŸå§‹æ™‚é–“ï¼š${input}\n` +
                    `åŠ ä¸Š46å°æ™‚å¾Œï¼š${formatDate(newDate)}`
                );
            } catch (e) {
                alert(`éŒ¯èª¤ï¼š${e.message}`);
            }
        }


    </script>
</body>

</html>